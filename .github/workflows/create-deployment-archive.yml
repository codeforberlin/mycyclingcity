# Copyright (c) 2026 SAI-Lab / MyCyclingCity
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# @file    create-deployment-archive.yml
# @author  Roland Rutz
# @note    This code was developed with the assistance of AI (LLMs).

name: Create Deployment Archive

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'mcc-web/**'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (optional)'
        required: false
        type: string

jobs:
  create-archive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe
    
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
    
      - name: Install gettext tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext
    
      - name: Install dependencies for translation check
        working-directory: mcc-web
        run: |
          pip install --upgrade pip
          # Install minimal dependencies needed for Django compilemessages
          pip install django==5.2.9 python-decouple==3.8 python-dotenv==1.0.0
          # Create minimal .env file if it doesn't exist (for decouple)
          if [ ! -f .env ]; then
            echo "SECRET_KEY=django-insecure-ci-build-key" > .env
            echo "DEBUG=True" >> .env
            echo "ALLOWED_HOSTS=localhost" >> .env
          fi
    
      - name: Create deployment archive
        working-directory: mcc-web
        run: |
          python utils/create_deployment_archive.py
        env:
          VERSION_OVERRIDE: ${{ inputs.version }}
    
      - name: Find archive file
        id: find-archive
        working-directory: mcc-web
        run: |
          ARCHIVE=$(ls -t mcc-web-deployment-*.tar.gz | head -n 1)
          echo "archive_name=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "archive_path=mcc-web/$ARCHIVE" >> $GITHUB_OUTPUT
          echo "Found archive: $ARCHIVE"
    
      - name: Upload deployment archive
        uses: actions/upload-artifact@v4
        with:
          name: mcc-web-deployment-archive
          path: ${{ steps.find-archive.outputs.archive_path }}
          retention-days: 30
    
      - name: Get archive info
        working-directory: mcc-web
        run: |
          ARCHIVE=$(ls -t mcc-web-deployment-*.tar.gz | head -n 1)
          SIZE=$(du -h "$ARCHIVE" | cut -f1)
          echo "ðŸ“¦ Deployment archive created: $ARCHIVE"
          echo "ðŸ“Š Size: $SIZE"
          echo "ðŸ”— Download from Actions artifacts"
