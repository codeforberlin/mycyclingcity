; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[env:heltec_wifi_lora_32_V3]
platform = espressif32
board = heltec_wifi_lora_32_V3
framework = arduino

monitor_speed = 115200
upload_speed = 921600

; --- NEUE EINSTELLUNGEN ZUR REDUZIERUNG DER CPU-FREQUENZ ---
; Gültige Werte sind: 240000000, 160000000, 80000000, 40000000
;board_build.f_cpu = 80000000  ; Reduziert die CPU-Frequenz auf 80 MHz

; Optional: Wenn Sie Probleme mit der seriellen Kommunikation haben
; board_build.f_flash = 40000000
; -----------------------------------------------------------


lib_deps =
    ; Bibliothek für JSON-Verarbeitung
    bblanchon/ArduinoJson@^6.19.4
    
    ; Bibliothek für das Heltec OLED-Display (SSD1306)
    olikraus/U8g2

    ; Bibliothek für das Modul MFRC522 zum Auslesen von ID Tags
    miguelbalboa/MFRC522@^1.4.12

 
    ; ESP32-spezifische Bibliotheken, die bereits im Framework enthalten sind
    ; driver/pcnt.h
    ; WiFi.h
    ; WebServer.h
    ; Preferences.h
    ; HTTPClient.h
    ; Update.h

build_flags =
    -D PulseMeasurePin=4 ; keine Leerzeichen vor und hinter dem =
    -D LED_PIN=35        ; interne LED
    -D VEXT_PIN=36       ; Pin zum Einschalten des integrierten OLED Panels
    -D BUZZER_PIN=14      ; Pin für den aktiven Buzzer
    -D ENABLE_OLED
    -D BOARD_HELTEC       ; für Board spezifische Anweisungen im Code
    -D OLED_SDA_PIN=17    ; I2C SDA für Heltec V3 OLED
    -D OLED_SCL_PIN=18    ; I2C SCL für Heltec V3 OLED
    -D OLED_RST_PIN=21    ; Reset-Pin für integriertes OLED
    ;-D ENABLE_RFID        ; RFID-Modul aktivieren
    -D FIRMWARE_VERSION=\"1.0.0\"  ; Firmware-Version für dieses Board
    ; Optionale Build-Zeit Standardwerte (werden nur verwendet, wenn NVS leer ist)
    -D DEFAULT_SERVER_URL=\"https://mycyclingcity.net\"
    -D DEFAULT_API_KEY=\"mcc-default-device-key-2026\"
    -D DEFAULT_ID_TAG=\"mccdevid\"
    -D DEFAULT_DEVICE_NAME=\"mccdev00\"

[env:heltec_wifi_lora_32_V2]
platform = espressif32
board = heltec_wifi_lora_32_V2
framework = arduino

monitor_speed = 115200
;upload_speed = 921600

lib_deps =
    ; Bibliothek für JSON-Verarbeitung
    bblanchon/ArduinoJson@^6.19.4

    ; Bibliothek für das Heltec OLED-Display (SSD1306)
    olikraus/U8g2

    ; ESP32-spezifische Bibliotheken, die bereits im Framework enthalten sind
    ; driver/pcnt.h
    ; WiFi.h
    ; WebServer.h
    ; Preferences.h
    ; HTTPClient.h
    ; Update.h

build_flags =
    -D PulseMeasurePin=13 ; keine Leerzeichen vor und hinter dem =
    -D LED_PIN=25         ; interne LED
    -D ENABLE_OLED      ; <-- Dieses Makro schaltet das OLED-Modul ein
    -D OLED_SDA_PIN=17    ; I2C SDA für Heltec V3 OLED
    -D OLED_SCL_PIN=18    ; I2C SCL für Heltec V3 OLED
    -D OLED_RST_PIN=21    ; Reset-Pin für integriertes OLED
    -D VEXT_PIN=36       ; Pin zum Einschalten des integrierten OLED Panels
    -D BUZZER_PIN=14      ; Pin für den aktiven Buzzer
    -D BOARD_HELTEC       ; für Board spezifische Anweisungen im Code
    -D FIRMWARE_VERSION=\"1.0.0\"  ; Firmware-Version für dieses Board
    ; Optionale Build-Zeit Standardwerte (werden nur verwendet, wenn NVS leer ist)
    ; -D DEFAULT_SERVER_URL=\"https://mycyclingcity.de\"
    ; -D DEFAULT_API_KEY=\"your-api-key-here\"

[env:wemos_d1_mini32]
platform = espressif32
board = wemos_d1_mini32
framework = arduino
monitor_speed = 115200
upload_speed = 921600
;upload_speed = 460800    ; Von 115200 erhöhen (921600 kann zu aggressiv sein)

lib_deps =
    ; Bibliothek für JSON-Verarbeitung
    bblanchon/ArduinoJson@^6.19.4

    ; Bibliothek für das Modul MFRC522 zum Auslesen von ID Tags
    miguelbalboa/MFRC522@^1.4.12
    olikraus/U8g2@^2.35.9

    ; ESP32-spezifische Bibliotheken, die bereits im Framework enthalten sind
    ; driver/pcnt.h
    ; WiFi.h
    ; WebServer.h
    ; Preferences.h
    ; HTTPClient.h
    ; Update.h

build_flags =
    -D PulseMeasurePin=4    ; 
    -D LED_PIN=2            ; interne LED
    -D BOARD_D1             ; für Board spezifische Anweisungen im Code
    -D BUZZER_PIN=14        ; Pin für den aktiven Buzzer

    -D ENABLE_OLED 
    -D ENABLE_RFID          ; RFID-Modul aktivieren 
    ; I2C Pin-Definitionen
    -D OLED_SDA_PIN=21              ; SDA auf Standard I2C GPIO 21
    -D OLED_SCL_PIN=22              ; SCL auf Standard I2C GPIO 22
    -D OLED_RST_PIN=-1              ; Reset-Pin (mit -1 für U8X8_PIN_NONE/Nicht verwendet)
    -D FIRMWARE_VERSION=\"1.0.0\"  ; Firmware-Version für dieses Board
    ; Standardwerte für Out-of-Box-Erfahrung (werden nur verwendet, wenn NVS leer ist)
    ; Diese ermöglichen es dem Gerät, sich ohne manuelle Konfiguration beim Server zu melden
    ; Die finale Konfiguration erfolgt dann remote über das mcc-web Admin-Interface
    -D DEFAULT_SERVER_URL=\"https://mycyclingcity.net\"
    -D DEFAULT_API_KEY=\"mcc-default-device-key-2026\"
    -D DEFAULT_ID_TAG=\"mccdevid\"
    -D DEFAULT_DEVICE_NAME=\"mccdev00\"


[env:test_mode]
extends = env:heltec_wifi_lora_32_V3
build_flags = 
    -D PIO_BUILD_TEST_MODE
    ; Test-Modus Standardwerte (können überschrieben werden)
    ; -D DEFAULT_SERVER_URL=\"https://mycyclingcity.de\"
    ; -D DEFAULT_API_KEY=\"your-api-key-here\"

; --- TEST ENVIRONMENTS ---

; Native Test Environment (für lokale Tests ohne Hardware)
[env:native]
platform = native
test_framework = unity
test_build_src = no
lib_deps =
    bblanchon/ArduinoJson@^6.19.4

build_flags =
    -D UNITY_INCLUDE_CONFIG_H
    -D ARDUINO=10808
    -D ESP32=1
    -D PulseMeasurePin=4
    -D LED_PIN=2
    -D BUZZER_PIN=14
    -D BOARD_D1
    -D ENABLE_OLED
    -D OLED_SDA_PIN=21
    -D OLED_SCL_PIN=22
    -D OLED_RST_PIN=-1
    -D UNITY_TEST_MODE
    -I test/mocks

; ESP32 Test Environment für wemos_d1_mini32
[env:wemos_d1_mini32_test]
extends = env:wemos_d1_mini32
test_framework = unity
test_build_src = yes

build_flags =
    ${env:wemos_d1_mini32.build_flags}
    -D UNITY_INCLUDE_CONFIG_H
    -D UNITY_TEST_MODE

