<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    analytics_dashboard.html
     @author  Roland Rutz
-->

{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n static l10n %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .analytics-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .filters-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filters-section h3 {
        margin-top: 0;
        color: #417690;
    }
    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
        margin-bottom: 15px;
    }
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }
    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s;
        color: white !important;
    }
    .btn-primary {
        background: #417690;
        color: white !important;
    }
    .btn-primary:hover {
        background: #205067;
        color: white !important;
    }
    .btn-success {
        background: #417690;
        color: white !important;
    }
    .btn-success:hover {
        background: #205067;
        color: white !important;
    }
    .btn-secondary {
        background: #417690;
        color: white !important;
    }
    .btn-secondary:hover {
        background: #205067;
        color: white !important;
    }
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-container h3 {
        margin-top: 0;
        color: #417690;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }
    .chart-wrapper {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-card h4 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
    }
    .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #417690;
    }
    .top-list {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .top-list h3 {
        margin-top: 0;
        color: #417690;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }
    .top-list table {
        width: 100%;
        border-collapse: collapse;
    }
    .top-list th,
    .top-list td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .top-list th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }
    .top-list tr:hover {
        background: #f8f9fa;
    }
    .export-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
    }
    .export-section h3 {
        margin-top: 0;
        color: #417690;
    }
    .export-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>{{ title }}</h1>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <h3>{% trans "Filters" %}</h3>
        <form method="get" id="filterForm" onsubmit="return handleFilterSubmit(event)">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="start_date">{% trans "Start Date" %}</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" required>
                </div>
                <div class="filter-group">
                    <label for="end_date">{% trans "End Date" %}</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" required>
                </div>
                <div class="filter-group" style="margin-left: 40px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="use_group_filter" value="true" {% if use_group_filter %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>{% trans "Group Filter" %}</span>
                    </label>
                    <select id="group_id" name="group_id" {% if not use_group_filter %}disabled{% endif %}>
                        <option value="">{% trans "All Groups" %}</option>
                        {% for group in groups %}
                            <option value="{{ group.id }}" {% if group_id == group.id|stringformat:"s" %}selected{% endif %}>
                                {{ group.name }} ({{ group.group_type }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="use_player_filter" value="true" {% if use_player_filter %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>{% trans "Cyclist Filter" %}</span>
                    </label>
                    <select id="player_id" name="player_id" {% if not use_player_filter %}disabled{% endif %}>
                        <option value="">{% trans "All Cyclists" %}</option>
                        {% for cyclist in players %}
                            <option value="{{ cyclist.id }}" {% if player_id == cyclist.id|stringformat:"s" %}selected{% endif %}>
                                {{ cyclist.user_id }} ({{ cyclist.id_tag }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="use_event_filter" value="true" {% if use_event_filter %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>{% trans "Event Filter" %}</span>
                    </label>
                    <select id="event_id" name="event_id" {% if not use_event_filter %}disabled{% endif %}>
                        <option value="">{% trans "All Events" %}</option>
                        {% for event in events %}
                            <option value="{{ event.id }}" {% if event_id == event.id|stringformat:"s" %}selected{% endif %}>
                                {{ event.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="use_track_filter" value="true" {% if use_track_filter %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>{% trans "Travel Track Filter" %}</span>
                    </label>
                    <select id="track_id" name="track_id" {% if not use_track_filter %}disabled{% endif %}>
                        <option value="">{% trans "All Tracks" %}</option>
                        {% for track in tracks %}
                            <option value="{{ track.id }}" {% if track_id == track.id|stringformat:"s" %}selected{% endif %}>
                                {{ track.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                <a href="{% url 'admin:api_analytics_dashboard' %}" class="btn btn-secondary">{% trans "Reset" %}</a>
                <a href="{% url 'admin:api_analytics_hierarchy' %}?start_date={{ start_date }}&end_date={{ end_date }}{% if event_id %}&event_id={{ event_id }}{% endif %}" class="btn btn-success">{% trans "Hierarchy Breakdown" %}</a>
            </div>
        </form>
    </div>
    
    <!-- Group Type Toggle -->
    <div style="margin: 20px 0; text-align: center;">
        <label style="display: inline-flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="groupTypeToggle" style="width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: 600;">{% trans "Show Top Groups (Master Groups)" %}</span>
            <span style="font-size: 14px; color: #666;">({% trans "Uncheck to show Subgroups with Cyclists" %})</span>
        </label>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <h4>{% trans "Total Distance" %}</h4>
            <div class="value" id="totalDistance">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(to bottom right, #fbbf24, #f59e0b); color: #1e293b; text-align: center;">
            <h4 style="color: #1e293b; margin-bottom: 8px;">üèÜ {% trans "Daily Record" %}</h4>
            <div id="dailyRecordParent" style="font-size: 12px; font-weight: 600; color: #1e293b; margin-bottom: 2px; opacity: 0.9;">-</div>
            <div id="dailyRecordHolder" style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 4px;">-</div>
            <div class="value" id="dailyTotal" style="color: #1e293b; font-size: 24px;">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(to bottom right, #60a5fa, #4f46e5); color: white; text-align: center;">
            <h4 style="color: white; margin-bottom: 8px;">üìÖ {% trans "Weekly Record" %}</h4>
            <div id="weeklyRecordParent" style="font-size: 12px; font-weight: 600; color: white; margin-bottom: 2px; opacity: 0.9;">-</div>
            <div id="weeklyRecordHolder" style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 4px;">-</div>
            <div class="value" id="weeklyTotal" style="color: white; font-size: 24px;">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(to bottom right, #4ade80, #10b981); color: #1e293b; text-align: center;">
            <h4 style="color: #1e293b; margin-bottom: 8px;">üóìÔ∏è {% trans "Monthly Record" %}</h4>
            <div id="monthlyRecordParent" style="font-size: 12px; font-weight: 600; color: #1e293b; margin-bottom: 2px; opacity: 0.9;">-</div>
            <div id="monthlyRecordHolder" style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 4px;">-</div>
            <div class="value" id="monthlyTotal" style="color: #1e293b; font-size: 24px;">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(to bottom right, #a78bfa, #ec4899); color: white; text-align: center;">
            <h4 style="color: white; margin-bottom: 8px;">üìÜ {% trans "Yearly Record" %}</h4>
            <div id="yearlyRecordParent" style="font-size: 12px; font-weight: 600; color: white; margin-bottom: 2px; opacity: 0.9;">-</div>
            <div id="yearlyRecordHolder" style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 4px;">-</div>
            <div class="value" id="yearlyTotal" style="color: white; font-size: 24px;">-</div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>{% trans "Daily Utilization" %}</h3>
            <div id="dailyChartStatus" style="padding: 10px; background: #f0f0f0; margin-bottom: 10px; border-radius: 4px;">
                <strong>Status:</strong> <span id="dailyChartStatusText">Initializing...</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>{% trans "Hourly Utilization" %}</h3>
            <div id="hourlyChartStatus" style="padding: 10px; background: #f0f0f0; margin-bottom: 10px; border-radius: 4px; display: none;">
                <strong>Status:</strong> <span id="hourlyChartStatusText">Initializing...</span>
            </div>
            <div class="chart-wrapper">
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Lists -->
    <div class="top-list">
        <h3>{% trans "Top Groups by Mileage" %}</h3>
        <table id="topGroupsTable">
            <thead>
                <tr>
                    <th>{% trans "Rank" %}</th>
                    <th>{% trans "Group" %}</th>
                    <th>{% trans "Type" %}</th>
                    <th>{% trans "Distance (km)" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="4" class="loading">{% trans "Loading..." %}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="top-list">
        <h3>{% trans "Top Cyclists by Mileage" %}</h3>
        <table id="topPlayersTable">
            <thead>
                <tr>
                    <th>{% trans "Rank" %}</th>
                    <th>{% trans "Cyclist" %}</th>
                    <th>{% trans "ID Tag" %}</th>
                    <th>{% trans "Group" %}</th>
                    <th>{% trans "Distance (km)" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="5" class="loading">{% trans "Loading..." %}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="top-list">
        <h3>{% trans "Top Devices by Mileage" %}</h3>
        <table id="topDevicesTable">
            <thead>
                <tr>
                    <th>{% trans "Rank" %}</th>
                    <th>{% trans "Device" %}</th>
                    <th>{% trans "Distance (km)" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3" class="loading">{% trans "Loading..." %}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Export Section -->
    <div class="export-section">
        <h3>{% trans "Export Data" %}</h3>
        <p>{% trans "Export the filtered report data in your preferred format:" %}</p>
        <div class="export-buttons">
            <a href="#" id="exportCsv" class="btn btn-success">{% trans "Export as CSV" %}</a>
            <a href="#" id="exportExcel" class="btn btn-success">{% trans "Export as Excel" %}</a>
        </div>
    </div>
</div>

<!-- JavaScript directly in content block -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" onload="console.log('Chart.js loaded successfully')" onerror="console.error('Chart.js failed to load!')"></script>
<script>
console.log('=== ANALYTICS DASHBOARD SCRIPT STARTING ===');
console.log('Timestamp:', new Date().toISOString());
console.log('Analytics dashboard script loaded');
console.log('Chart.js available:', typeof Chart !== 'undefined');

// Wait for Chart.js to load
if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded!');
}

// Format number based on current language
function formatNumberDE(value, decimals) {
    if (value === null || value === undefined || isNaN(value)) {
        const lang = document.documentElement.lang || 'de';
        const isGerman = lang.startsWith('de');
        const decimalSep = isGerman ? ',' : '.';
        return '0' + (decimals > 0 ? decimalSep + '0'.repeat(decimals) : '');
    }
    const num = parseFloat(value);
    const fixed = num.toFixed(decimals || 3);
    const parts = fixed.split('.');
    const integerStr = parts[0];
    const decimalPart = parts[1] || '';
    
    // Get language from HTML lang attribute
    const lang = document.documentElement.lang || 'de';
    const isGerman = lang.startsWith('de');
    
    // Add thousands separators
    let integerWithSeparators = '';
    for (let i = 0; i < integerStr.length; i++) {
        if (i > 0 && (integerStr.length - i) % 3 === 0) {
            integerWithSeparators += isGerman ? '.' : ',';
        }
        integerWithSeparators += integerStr[i];
    }
    
    // Add decimal separator
    if (decimalPart) {
        return integerWithSeparators + (isGerman ? ',' : '.') + decimalPart;
    }
    return integerWithSeparators;
}

(function() {
    console.log('Analytics dashboard script executing');
    // Get filter values
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date') || '{{ start_date }}';
    const endDate = urlParams.get('end_date') || '{{ end_date }}';
    const eventId = urlParams.get('event_id') || '';
    const groupId = urlParams.get('group_id') || '';
    const playerId = urlParams.get('player_id') || '';
    const trackId = urlParams.get('track_id') || '';
    console.log('Filter values:', {startDate, endDate, eventId, groupId, playerId, trackId});
    
    // Handle filter form submission - ensure checkboxes are included even if unchecked
    function handleFilterSubmit(event) {
        const form = event.target;
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name^="use_"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                // Add hidden input to ensure unchecked checkboxes are sent as false
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = checkbox.name;
                hiddenInput.value = 'false';
                form.appendChild(hiddenInput);
            }
        });
        return true; // Allow form submission
    }
    
    // Chart instances
    let dailyChart = null;
    let hourlyChart = null;
    
    // Initialize charts
    function initCharts() {
        console.log('=== initCharts() called ===');
        const dailyCtx = document.getElementById('dailyChart');
        const hourlyCtx = document.getElementById('hourlyChart');
        
        console.log('Daily canvas found:', !!dailyCtx, dailyCtx);
        console.log('Hourly canvas found:', !!hourlyCtx, hourlyCtx);
        console.log('Chart.js available:', typeof Chart !== 'undefined');
        
        if (!dailyCtx || !hourlyCtx) {
            console.error('Chart canvases not found!');
            console.error('Daily canvas:', dailyCtx);
            console.error('Hourly canvas:', hourlyCtx);
            throw new Error('Canvas elements not found');
        }
        
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not available!');
            throw new Error('Chart.js not loaded');
        }
        
        if (dailyChart) {
            console.log('Destroying existing daily chart');
            try {
                dailyChart.destroy();
            } catch (e) {
                console.warn('Error destroying daily chart:', e);
            }
        }
        if (hourlyChart) {
            console.log('Destroying existing hourly chart');
            try {
                hourlyChart.destroy();
            } catch (e) {
                console.warn('Error destroying hourly chart:', e);
            }
        }
        
        console.log('Creating daily chart...');
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not available!');
            return;
        }
        dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '{% trans "Daily Distance (km)" %}',
                    data: [],
                    borderColor: 'rgb(65, 118, 144)',
                    backgroundColor: 'rgba(65, 118, 144, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Distance (km)" %}'
                        }
                    }
                }
            }
        });
        console.log('Daily chart created');
        
        console.log('Creating hourly chart...');
        hourlyChart = new Chart(hourlyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '{% trans "Hourly Distance (km)" %}',
                    data: [],
                    borderColor: 'rgb(40, 167, 69)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Distance (km)" %}'
                        }
                    }
                }
            }
        });
        console.log('Hourly chart created');
    }
    
    // Load data
    function loadData() {
        console.log('Loading data with params:', {startDate, endDate, eventId, groupId, playerId});
        
        // Get filter checkboxes
        const useEventFilter = document.querySelector('input[name="use_event_filter"]')?.checked || false;
        const useGroupFilter = document.querySelector('input[name="use_group_filter"]')?.checked || false;
        const usePlayerFilter = document.querySelector('input[name="use_player_filter"]')?.checked || false;
        const useTrackFilter = document.querySelector('input[name="use_track_filter"]')?.checked || false;
        const trackId = document.getElementById('track_id')?.value || '';
        
        // Load daily data
        const dailyUrl = `{% url 'admin:api_analytics_data_api' %}?start_date=${startDate}&end_date=${endDate}&event_id=${eventId}&group_id=${groupId}&player_id=${playerId}&track_id=${trackId}&use_event_filter=${useEventFilter}&use_group_filter=${useGroupFilter}&use_player_filter=${usePlayerFilter}&use_track_filter=${useTrackFilter}&report_type=daily`;
        console.log('Fetching daily data from:', dailyUrl);
        fetch(dailyUrl)
            .then(response => {
                console.log('Daily response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Daily data received:', data);
                if (data.daily && data.daily.labels && data.daily.labels.length > 0) {
                    if (!dailyChart) {
                        console.error('Daily chart not initialized');
                        updateStatus('dailyChartStatusText', 'Error: Chart not initialized', '#f44336');
                        return;
                    }
                    dailyChart.data.labels = data.daily.labels;
                    dailyChart.data.datasets[0].data = data.daily.data;
                    dailyChart.update();
                    console.log('Daily chart updated with', data.daily.labels.length, 'data points');
                    updateStatus('dailyChartStatusText', 'Loaded: ' + data.daily.labels.length + ' data points', '#4CAF50');
                } else {
                    console.warn('No daily data in response:', data);
                    updateStatus('dailyChartStatusText', 'No data available', '#ff9800');
                }
            })
            .catch(error => {
                console.error('Error loading daily data:', error);
            });
        
        // Load hourly data
        const hourlyUrl = `{% url 'admin:api_analytics_data_api' %}?start_date=${startDate}&end_date=${endDate}&event_id=${eventId}&group_id=${groupId}&player_id=${playerId}&track_id=${trackId}&use_event_filter=${useEventFilter}&use_group_filter=${useGroupFilter}&use_player_filter=${usePlayerFilter}&use_track_filter=${useTrackFilter}&report_type=hourly`;
        console.log('Fetching hourly data from:', hourlyUrl);
        fetch(hourlyUrl)
            .then(response => {
                console.log('Hourly response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Hourly data received:', data);
                if (data.hourly && data.hourly.labels && data.hourly.labels.length > 0) {
                    if (!hourlyChart) {
                        console.error('Hourly chart not initialized');
                        updateStatus('hourlyChartStatusText', 'Error: Chart not initialized', '#f44336');
                        return;
                    }
                    hourlyChart.data.labels = data.hourly.labels;
                    hourlyChart.data.datasets[0].data = data.hourly.data;
                    hourlyChart.update();
                    console.log('Hourly chart updated with', data.hourly.labels.length, 'data points');
                    updateStatus('hourlyChartStatusText', 'Loaded: ' + data.hourly.labels.length + ' data points', '#4CAF50');
                } else {
                    console.warn('No hourly data in response:', data);
                    updateStatus('hourlyChartStatusText', 'No data available', '#ff9800');
                }
            })
            .catch(error => {
                console.error('Error loading hourly data:', error);
            });
        
        // Load aggregated data
        loadAggregatedData();
    }
    
    // Function to load aggregated data
    function loadAggregatedData() {
            const groupTypeToggle = document.getElementById('groupTypeToggle');
            const showTopGroups = groupTypeToggle ? groupTypeToggle.checked : true;
            const groupType = showTopGroups ? 'top_groups' : 'subgroups';
            
            // Get filter checkboxes
            const useEventFilter = document.querySelector('input[name="use_event_filter"]')?.checked || false;
            const useGroupFilter = document.querySelector('input[name="use_group_filter"]')?.checked || false;
            const usePlayerFilter = document.querySelector('input[name="use_player_filter"]')?.checked || false;
            const useTrackFilter = document.querySelector('input[name="use_track_filter"]')?.checked || false;
            const trackId = document.getElementById('track_id')?.value || '';
            
            const aggregatedUrl = `{% url 'admin:api_analytics_data_api' %}?start_date=${startDate}&end_date=${endDate}&event_id=${eventId}&group_id=${groupId}&player_id=${playerId}&track_id=${trackId}&use_event_filter=${useEventFilter}&use_group_filter=${useGroupFilter}&use_player_filter=${usePlayerFilter}&use_track_filter=${useTrackFilter}&report_type=aggregated&group_type=${groupType}`;
            console.log('Fetching aggregated data from:', aggregatedUrl);
            fetch(aggregatedUrl)
            .then(response => {
                console.log('Aggregated response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Aggregated data received:', data);
                if (data.aggregated) {
                    // Update total distance (German format)
                    document.getElementById('totalDistance').textContent = 
                        formatNumberDE(data.aggregated.total_distance || 0, 2) + ' km';
                    
                    // Update daily record holder
                    const dailyRecordParentEl = document.getElementById('dailyRecordParent');
                    const dailyRecordHolderEl = document.getElementById('dailyRecordHolder');
                    const dailyTotalEl = document.getElementById('dailyTotal');
                    if (data.aggregated.daily_record_holder && data.aggregated.daily_record_value > 0) {
                        if (dailyRecordParentEl) {
                            dailyRecordParentEl.textContent = data.aggregated.daily_record_holder.parent_group_name ? 
                                'üè´ ' + data.aggregated.daily_record_holder.parent_group_name : '';
                        }
                        if (dailyRecordHolderEl) {
                            dailyRecordHolderEl.textContent = data.aggregated.daily_record_holder.name || '-';
                        }
                        if (dailyTotalEl) {
                            dailyTotalEl.textContent = formatNumberDE(data.aggregated.daily_record_value || 0, 2) + ' km';
                        }
                    } else {
                        // Show total even if no record holder
                        if (dailyRecordParentEl) {
                            dailyRecordParentEl.textContent = '';
                        }
                        if (dailyRecordHolderEl) {
                            dailyRecordHolderEl.textContent = '-';
                        }
                        if (dailyTotalEl) {
                            dailyTotalEl.textContent = formatNumberDE(data.aggregated.daily_total || 0, 2) + ' km';
                        }
                    }
                    
                    // Update weekly record holder
                    const weeklyRecordParentEl = document.getElementById('weeklyRecordParent');
                    const weeklyRecordHolderEl = document.getElementById('weeklyRecordHolder');
                    const weeklyTotalEl = document.getElementById('weeklyTotal');
                    if (data.aggregated.weekly_record_holder && data.aggregated.weekly_record_value > 0) {
                        if (weeklyRecordParentEl) {
                            weeklyRecordParentEl.textContent = data.aggregated.weekly_record_holder.parent_group_name ? 
                                'üè´ ' + data.aggregated.weekly_record_holder.parent_group_name : '';
                        }
                        if (weeklyRecordHolderEl) {
                            weeklyRecordHolderEl.textContent = data.aggregated.weekly_record_holder.name || '-';
                        }
                        if (weeklyTotalEl) {
                            weeklyTotalEl.textContent = formatNumberDE(data.aggregated.weekly_record_value || 0, 2) + ' km';
                        }
                    } else {
                        // Show total even if no record holder
                        if (weeklyRecordParentEl) {
                            weeklyRecordParentEl.textContent = '';
                        }
                        if (weeklyRecordHolderEl) {
                            weeklyRecordHolderEl.textContent = '-';
                        }
                        if (weeklyTotalEl) {
                            weeklyTotalEl.textContent = formatNumberDE(data.aggregated.weekly_total || 0, 2) + ' km';
                        }
                    }
                    
                    // Update monthly record holder
                    const monthlyRecordParentEl = document.getElementById('monthlyRecordParent');
                    const monthlyRecordHolderEl = document.getElementById('monthlyRecordHolder');
                    const monthlyTotalEl = document.getElementById('monthlyTotal');
                    if (data.aggregated.monthly_record_holder && data.aggregated.monthly_record_value > 0) {
                        if (monthlyRecordParentEl) {
                            monthlyRecordParentEl.textContent = data.aggregated.monthly_record_holder.parent_group_name ? 
                                'üè´ ' + data.aggregated.monthly_record_holder.parent_group_name : '';
                        }
                        if (monthlyRecordHolderEl) {
                            monthlyRecordHolderEl.textContent = data.aggregated.monthly_record_holder.name || '-';
                        }
                        if (monthlyTotalEl) {
                            monthlyTotalEl.textContent = formatNumberDE(data.aggregated.monthly_record_value || 0, 2) + ' km';
                        }
                    } else {
                        // Show total even if no record holder
                        if (monthlyRecordParentEl) {
                            monthlyRecordParentEl.textContent = '';
                        }
                        if (monthlyRecordHolderEl) {
                            monthlyRecordHolderEl.textContent = '-';
                        }
                        if (monthlyTotalEl) {
                            monthlyTotalEl.textContent = formatNumberDE(data.aggregated.monthly_total || 0, 2) + ' km';
                        }
                    }
                    
                    // Update yearly record holder
                    const yearlyRecordParentEl = document.getElementById('yearlyRecordParent');
                    const yearlyRecordHolderEl = document.getElementById('yearlyRecordHolder');
                    const yearlyTotalEl = document.getElementById('yearlyTotal');
                    if (data.aggregated.yearly_record_holder && data.aggregated.yearly_record_value > 0) {
                        if (yearlyRecordParentEl) {
                            yearlyRecordParentEl.textContent = data.aggregated.yearly_record_holder.parent_group_name ? 
                                'üè´ ' + data.aggregated.yearly_record_holder.parent_group_name : '';
                        }
                        if (yearlyRecordHolderEl) {
                            yearlyRecordHolderEl.textContent = data.aggregated.yearly_record_holder.name || '-';
                        }
                        if (yearlyTotalEl) {
                            yearlyTotalEl.textContent = formatNumberDE(data.aggregated.yearly_record_value || 0, 2) + ' km';
                        }
                    } else {
                        // Show total even if no record holder
                        if (yearlyRecordParentEl) {
                            yearlyRecordParentEl.textContent = '';
                        }
                        if (yearlyRecordHolderEl) {
                            yearlyRecordHolderEl.textContent = '-';
                        }
                        if (yearlyTotalEl) {
                            yearlyTotalEl.textContent = formatNumberDE(data.aggregated.yearly_total || 0, 2) + ' km';
                        }
                    }
                    
                    // Update top groups
                    const topGroupsTbody = document.querySelector('#topGroupsTable tbody');
                    topGroupsTbody.innerHTML = '';
                    if (data.aggregated.top_groups && data.aggregated.top_groups.length > 0) {
                        data.aggregated.top_groups.forEach((group, index) => {
                            const row = topGroupsTbody.insertRow();
                            row.insertCell(0).textContent = index + 1;
                            row.insertCell(1).textContent = group.name || '{% trans "Unknown" %}';
                            row.insertCell(2).textContent = group.type || '';
                            row.insertCell(3).textContent = formatNumberDE(group.distance || 0, 2);
                        });
                    } else {
                        const row = topGroupsTbody.insertRow();
                        row.insertCell(0).colSpan = 4;
                        row.insertCell(0).textContent = '{% trans "No data available for the selected filters." %}';
                        row.insertCell(0).style.textAlign = 'center';
                        row.insertCell(0).style.padding = '20px';
                    }
                    
                    // Update top players
                    const topPlayersTbody = document.querySelector('#topPlayersTable tbody');
                    topPlayersTbody.innerHTML = '';
                    if (data.aggregated.top_players && data.aggregated.top_players.length > 0) {
                        data.aggregated.top_players.forEach((cyclist, index) => {
                            const row = topPlayersTbody.insertRow();
                            row.insertCell(0).textContent = index + 1;
                            row.insertCell(1).textContent = cyclist.user_id || '';
                            row.insertCell(2).textContent = cyclist.id_tag || '';
                            row.insertCell(3).textContent = cyclist.group || '{% trans "Unknown" %}';
                            row.insertCell(4).textContent = formatNumberDE(cyclist.distance || 0, 2);
                        });
                    } else {
                        const row = topPlayersTbody.insertRow();
                        row.insertCell(0).colSpan = 5;
                        row.insertCell(0).textContent = '{% trans "No data available for the selected filters." %}';
                        row.insertCell(0).style.textAlign = 'center';
                        row.insertCell(0).style.padding = '20px';
                    }
                    
                    // Update top devices
                    const topDevicesTbody = document.querySelector('#topDevicesTable tbody');
                    topDevicesTbody.innerHTML = '';
                    if (data.aggregated.top_devices && data.aggregated.top_devices.length > 0) {
                        data.aggregated.top_devices.forEach((device, index) => {
                            const row = topDevicesTbody.insertRow();
                            row.insertCell(0).textContent = index + 1;
                            row.insertCell(1).textContent = device.name || '';
                            row.insertCell(2).textContent = formatNumberDE(device.distance || 0, 2);
                        });
                    } else {
                        const row = topDevicesTbody.insertRow();
                        row.insertCell(0).colSpan = 3;
                        row.insertCell(0).textContent = '{% trans "No data available for the selected filters." %}';
                        row.insertCell(0).style.textAlign = 'center';
                        row.insertCell(0).style.padding = '20px';
                    }
                }
            })
            .catch(error => console.error('Error loading aggregated data:', error));
    }
    
    // Update status indicators (must be defined early)
    function updateStatus(elementId, text, color) {
        console.log('updateStatus called:', elementId, text);
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
            element.style.color = color || '#000';
            console.log('Status updated successfully:', elementId);
        } else {
            console.error('Status element not found:', elementId);
            // Try to find it with querySelector as fallback
            const fallback = document.querySelector('#' + elementId);
            if (fallback) {
                console.log('Found with querySelector');
                fallback.textContent = text;
                fallback.style.color = color || '#000';
            } else {
                console.error('Element not found with either method:', elementId);
            }
        }
    }
    
    // Export handlers
    const exportCsvBtn = document.getElementById('exportCsv');
    const exportExcelBtn = document.getElementById('exportExcel');
    
    if (exportCsvBtn) {
        exportCsvBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = `{% url 'admin:api_analytics_export' %}?start_date=${startDate}&end_date=${endDate}&event_id=${eventId}&group_id=${groupId}&player_id=${playerId}&format=csv`;
            window.location.href = url;
        });
    }
    
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = `{% url 'admin:api_analytics_export' %}?start_date=${startDate}&end_date=${endDate}&event_id=${eventId}&group_id=${groupId}&player_id=${playerId}&format=excel`;
            window.location.href = url;
        });
    }
    
    // Initialize on page load
    console.log('Setting up initialization...');
    console.log('Document ready state:', document.readyState);
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    
    function initializeAnalytics() {
        console.log('=== Starting analytics initialization ===');
        
        // Update status
        try {
            updateStatus('dailyChartStatusText', 'Initializing charts...', '#ff9800');
            updateStatus('hourlyChartStatusText', 'Initializing charts...', '#ff9800');
        } catch (e) {
            console.error('Error updating status:', e);
        }
        
        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded!');
            updateStatus('dailyChartStatusText', 'Error: Chart.js not loaded', '#f44336');
            updateStatus('hourlyChartStatusText', 'Error: Chart.js not loaded', '#f44336');
            return;
        }
        
        // Check if canvas elements exist
        const dailyCtx = document.getElementById('dailyChart');
        const hourlyCtx = document.getElementById('hourlyChart');
        console.log('Daily canvas found:', !!dailyCtx);
        console.log('Hourly canvas found:', !!hourlyCtx);
        
        if (!dailyCtx || !hourlyCtx) {
            console.error('Canvas elements not found!');
            updateStatus('dailyChartStatusText', 'Error: Canvas not found', '#f44336');
            updateStatus('hourlyChartStatusText', 'Error: Canvas not found', '#f44336');
            return;
        }
        
        try {
            console.log('Calling initCharts()...');
            initCharts();
            console.log('Charts initialized successfully');
            
            updateStatus('dailyChartStatusText', 'Charts created, loading data...', '#2196F3');
            updateStatus('hourlyChartStatusText', 'Charts created, loading data...', '#2196F3');
            
            // Initialize toggle state from localStorage
            const groupTypeToggle = document.getElementById('groupTypeToggle');
            if (groupTypeToggle) {
                // Load saved state from localStorage (default to true/checked)
                const savedState = localStorage.getItem('analyticsGroupTypeToggle');
                if (savedState !== null) {
                    groupTypeToggle.checked = savedState === 'true';
                } else {
                    groupTypeToggle.checked = true; // Default to checked
                }
                
                // Add toggle event handler for group type
                groupTypeToggle.addEventListener('change', function() {
                    console.log('Group type toggle changed:', this.checked);
                    // Save state to localStorage
                    localStorage.setItem('analyticsGroupTypeToggle', this.checked.toString());
                    // Immediately reload aggregated data
                    loadAggregatedData();
                });
            }
            
            // Enable/disable filter selects based on checkboxes
            function updateFilterSelects() {
                const eventCheckbox = document.querySelector('input[name="use_event_filter"]');
                const groupCheckbox = document.querySelector('input[name="use_group_filter"]');
                const playerCheckbox = document.querySelector('input[name="use_player_filter"]');
                const trackCheckbox = document.querySelector('input[name="use_track_filter"]');
                
                if (eventCheckbox) {
                    const eventSelect = document.getElementById('event_id');
                    if (eventSelect) {
                        eventSelect.disabled = !eventCheckbox.checked;
                    }
                }
                if (groupCheckbox) {
                    const groupSelect = document.getElementById('group_id');
                    if (groupSelect) {
                        groupSelect.disabled = !groupCheckbox.checked;
                    }
                }
                if (playerCheckbox) {
                    const playerSelect = document.getElementById('player_id');
                    if (playerSelect) {
                        playerSelect.disabled = !playerCheckbox.checked;
                    }
                }
                if (trackCheckbox) {
                    const trackSelect = document.getElementById('track_id');
                    if (trackSelect) {
                        trackSelect.disabled = !trackCheckbox.checked;
                    }
                }
            }
            
            // Initialize filter selects
            updateFilterSelects();
            
            // Add event listeners to filter checkboxes
            const filterCheckboxes = document.querySelectorAll('input[name^="use_"]');
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateFilterSelects();
                    // Reload data when filter checkbox changes
                    loadData();
                });
            });
            
            console.log('Calling loadData()...');
            loadData();
            console.log('Data loading started');
        } catch (error) {
            console.error('Error during initialization:', error);
            console.error('Error stack:', error.stack);
            updateStatus('dailyChartStatusText', 'Error: ' + (error.message || String(error)), '#f44336');
            updateStatus('hourlyChartStatusText', 'Error: ' + (error.message || String(error)), '#f44336');
        }
    }
    
    // Try to update status immediately to test if function works
    console.log('Testing updateStatus function...');
    try {
        updateStatus('dailyChartStatusText', 'Testing status update...', '#666');
        updateStatus('hourlyChartStatusText', 'Testing status update...', '#666');
        console.log('Status update test completed');
    } catch (e) {
        console.error('Error in status update test:', e);
    }
    
    // Wait for DOM to be ready
    function waitForDOM() {
        console.log('waitForDOM called, readyState:', document.readyState);
        if (document.readyState === 'loading') {
            console.log('DOM still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOMContentLoaded fired');
                setTimeout(function() {
                    console.log('Calling initializeAnalytics from DOMContentLoaded...');
                    initializeAnalytics();
                }, 50);
            });
        } else {
            console.log('DOM already loaded, initializing...');
            setTimeout(function() {
                console.log('Calling initializeAnalytics immediately...');
                initializeAnalytics();
            }, 50);
        }
    }
    
    // Also try window.onload as fallback
    window.addEventListener('load', function() {
        console.log('Window load event fired');
        if (!dailyChart || !hourlyChart) {
            console.log('Charts not initialized yet, trying again...');
            setTimeout(function() {
                console.log('Calling initializeAnalytics from window.onload...');
                initializeAnalytics();
            }, 100);
        }
    });
    
    // Start initialization
    console.log('Starting waitForDOM...');
    waitForDOM();
    
    console.log('Script execution completed');
})();
</script>
{% endblock %}

