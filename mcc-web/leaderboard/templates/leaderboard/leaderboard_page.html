<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    leaderboard_page.html
     @author  Roland Rutz
     @note    This code was developed with the assistance of AI (LLMs).
-->

{% load i18n l10n leaderboard_filters %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Kiosk-Rangliste" %}</title>
    {% url 'favicon' as favicon_url %}
    <link rel="icon" type="image/png" href="{{ favicon_url }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        @keyframes pulse-ring {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .trophy-badge {
            transform: rotate(12deg);
        }
        .progress-bar {
            height: 2px;
            transition: width 0.1s linear;
        }
        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        .ticker-wrapper {
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        .ticker-marquee {
            display: inline-flex;
            will-change: transform;
            white-space: nowrap;
            animation: marquee 30s linear infinite;
        }
        .ticker-marquee > * {
            flex-shrink: 0;
        }
        .ticker-marquee:hover {
            animation-play-state: paused;
        }
        #ticker-content {
            display: inline-flex;
            white-space: nowrap;
        }

        /* ============================================
           Mobile-Only Overrides (max-width: 1023px)
           Protects Kiosk Mode - Desktop remains untouched
           ============================================ */
        @media screen and (max-width: 1023px) {
            /* Root Scaling: Scale up all rem-based elements for mobile */
            html {
                font-size: 110%; /* Scales all rem-based elements up */
            }

            /* Typography: Ensure minimum readable size for mobile */
            body {
                font-size: 16px; /* Minimum readable size for mobile */
                line-height: 1.5;
            }

            /* Map optimization: Full height with absolute positioning to remove white gap */
            #map {
                height: 100vh !important; /* Full height */
                width: 100vw !important;
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
            }

            /* Map view: Full screen on mobile */
            #map-view {
                overflow: hidden;
            }

            /* Leaderboard view: Enable scrolling on mobile */
            #leaderboard-view {
                overflow-y: auto;
                overflow-x: hidden;
            }

            /* Ticker: Adjust height for mobile */
            .h-\[5vh\] {
                min-height: 40px;
            }

            /* Banner: Adjust height for mobile */
            .h-\[15vh\] {
                min-height: 80px;
            }

            /* Main content: Better mobile layout */
            #leaderboard-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Footer: Adjust height for mobile */
            .h-\[5vh\] {
                min-height: 40px;
            }

            /* Touch targets: Increase size for buttons and interactive elements */
            button, a, select, input {
                min-height: 44px; /* Touch-friendly minimum height */
                min-width: 44px;
                padding: 15px 25px; /* Larger padding for better touch targets */
                font-size: 16px; /* Ensure readable text */
            }

            /* Ticker text: Better mobile readability */
            .ticker-marquee {
                font-size: 16px; /* Increased from 14px for better readability */
            }

            /* Banner content: Better mobile padding */
            .px-6 {
                padding-left: 20px; /* Increased padding */
                padding-right: 20px;
            }

            /* Small text blocks and labels: Ensure minimum readable size */
            label, .text-sm {
                font-size: 14px; /* Minimum readable size for labels */
            }
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-slate-900 text-white">
    <!-- Leaderboard View -->
    <div id="leaderboard-view" class="h-full w-full flex flex-col">
            <!-- Top Layer: Ticker (5vh) -->
            <div class="h-[5vh] bg-yellow-400 text-black border-b-2 border-yellow-600 overflow-hidden relative">
                <div class="ticker-wrapper h-full">
                    <div class="ticker-marquee whitespace-nowrap text-lg font-bold">
                        <div id="ticker-content"
                             hx-get="{% url 'leaderboard:leaderboard_page' %}?ticker_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
                             hx-trigger="every {{ KIOSK_TICKER_UPDATE_INTERVAL }}s"
                             hx-swap="innerHTML"
                             hx-target="this">
                            {% include 'leaderboard/partials/ticker.html' %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Header: Parent Group Banner (15vh) -->
            <div class="h-[15vh] bg-gradient-to-r from-slate-800 to-slate-900 border-b border-slate-700 flex items-center justify-center relative overflow-hidden px-6">
                <div id="banner-content"
                     hx-get="{% url 'leaderboard:leaderboard_page' %}?banner_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
                     hx-trigger="every {{ KIOSK_BANNER_UPDATE_INTERVAL }}s"
                     hx-swap="innerHTML"
                     hx-target="this">
                    {% include 'leaderboard/partials/banner.html' %}
                </div>
            </div>
            
            <!-- Main: Group Grid (75vh) -->
            <div id="leaderboard-content" class="flex-1 overflow-hidden" 
                 hx-get="{% url 'leaderboard:leaderboard_page' %}{% if current_filter %}?group={{ current_filter|urlencode }}{% endif %}{% if sort_by and sort_by != 'daily' %}{% if current_filter %}&{% else %}?{% endif %}sort={{ sort_by|urlencode }}{% endif %}" 
                 hx-trigger="every {{ KIOSK_CONTENT_UPDATE_INTERVAL }}s, tickerCyclistCountChanged from:body" 
                 hx-swap="innerHTML" 
                 hx-target="this">
                {% include 'leaderboard/partials/content.html' %}
            </div>
            
            <!-- Footer: Statistics (5vh) -->
            <div class="h-[5vh] bg-slate-800 border-t border-slate-700"
                 id="leaderboard-footer"
                 hx-get="{% url 'leaderboard:leaderboard_page' %}?footer_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
                 hx-trigger="every {{ KIOSK_FOOTER_UPDATE_INTERVAL }}s, tickerCyclistCountChanged from:body"
                 hx-swap="innerHTML"
                 hx-target="this">
                {% include 'leaderboard/partials/footer.html' %}
            </div>
        </div>
    
    <script>
        
        // Ticker animation - ensure seamless scrolling
        function duplicateTickerContent() {
            const tickerContent = document.getElementById('ticker-content');
            const tickerMarquee = document.querySelector('.ticker-marquee');
            if (tickerContent && tickerMarquee) {
                // Remove all existing duplicates
                const existingDuplicates = tickerMarquee.querySelectorAll('#ticker-content-duplicate');
                existingDuplicates.forEach(dup => dup.remove());
                
                // Create duplicate to ensure seamless infinite scroll
                const duplicate = tickerContent.cloneNode(true);
                duplicate.id = 'ticker-content-duplicate';
                duplicate.removeAttribute('hx-get');
                duplicate.removeAttribute('hx-trigger');
                duplicate.removeAttribute('hx-swap');
                duplicate.removeAttribute('hx-target');
                // Insert duplicate right after the original content
                tickerMarquee.insertBefore(duplicate, tickerContent.nextSibling);
            }
        }
        
        // Track active cyclist count to detect changes
        let previousActiveCyclistCount = -1;  // Use -1 to force initial update
        
        function countActiveCyclistsInTicker() {
            const tickerContent = document.getElementById('ticker-content');
            if (!tickerContent) return 0;
            
            // Count ticker items (each cyclist is in a ticker-item span)
            const tickerItems = tickerContent.querySelectorAll('.ticker-item');
            // Filter out the "Ready to start" message
            let count = 0;
            tickerItems.forEach(item => {
                const text = item.textContent || '';
                // If it contains "Ready to start" or similar, don't count it
                // Also check if it contains a user_id (which would be in <strong> tags)
                const hasUserId = item.querySelector('strong');
                if (hasUserId && !text.includes('Ready to start') && !text.includes('Bereit zum Start')) {
                    count++;
                }
            });
            return count;
        }
        
        // Initialize cyclist count on page load
        previousActiveCyclistCount = countActiveCyclistsInTicker();
        
        // Duplicate content after HTMX updates to ensure seamless animation
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'ticker-content') {
                // Wait a bit to ensure content is rendered
                requestAnimationFrame(() => {
                    duplicateTickerContent();
                    
                    // Check if active cyclist count has changed
                    const currentActiveCyclistCount = countActiveCyclistsInTicker();
                    if (currentActiveCyclistCount !== previousActiveCyclistCount) {
                        // Cyclist count changed - trigger immediate update of footer and content
                        const oldCount = previousActiveCyclistCount;
                        previousActiveCyclistCount = currentActiveCyclistCount;
                        
                        // Dispatch custom event to trigger updates
                        const updateEvent = new CustomEvent('tickerCyclistCountChanged', {
                            bubbles: true,
                            detail: { 
                                previousCount: oldCount,
                                currentCount: currentActiveCyclistCount 
                            }
                        });
                        document.body.dispatchEvent(updateEvent);
                    }
                });
            }
        });
        
        // Initial duplicate on page load and initialize cyclist count
        function initializeTicker() {
            setTimeout(() => {
                duplicateTickerContent();
                // Initialize cyclist count after content is duplicated
                previousActiveCyclistCount = countActiveCyclistsInTicker();
            }, 100);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTicker);
        } else {
            initializeTicker();
        }
        
        // Dynamic banner group visibility based on viewport width
        function adjustBannerGroups() {
            const bannerContainer = document.getElementById('banner-groups');
            if (!bannerContainer) return;
            
            const groups = bannerContainer.querySelectorAll('.banner-group-item');
            if (groups.length === 0) return;
            
            // Get the parent container (the banner div)
            const bannerParent = bannerContainer.parentElement;
            if (!bannerParent) return;
            
            // Reset all groups to visible first
            groups.forEach(group => {
                group.style.display = '';
            });
            
            // Force a reflow to get accurate measurements
            bannerContainer.offsetHeight;
            
            // Get actual container dimensions
            const containerRect = bannerParent.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerLeft = containerRect.left;
            const containerRight = containerRect.right;
            
            // Get container padding
            const containerStyle = window.getComputedStyle(bannerParent);
            const paddingLeft = parseFloat(containerStyle.paddingLeft) || 0;
            const paddingRight = parseFloat(containerStyle.paddingRight) || 0;
            
            // Calculate trophy badge space more accurately
            const trophyBadge = document.querySelector('.trophy-badge');
            let badgeRightSpace = 0;
            if (trophyBadge) {
                const badgeRect = trophyBadge.getBoundingClientRect();
                const containerRect = bannerParent.getBoundingClientRect();
                // Calculate space from left edge of badge to right edge of container
                const badgeLeft = badgeRect.left;
                const badgeRight = badgeRect.right;
                const containerRight = containerRect.right;
                // Space needed: from container right edge to badge left edge, plus badge width, plus extra margin
                badgeRightSpace = containerRight - badgeLeft + 32; // 32px extra margin for safety
            }
            
            // Available width: container width minus badge space minus both paddings
            // No extra margin needed since groups start from left (justify-start)
            const availableWidth = containerWidth - badgeRightSpace - paddingLeft - paddingRight;
            const gap = 24; // gap-6 = 1.5rem = 24px
            
            // Measure all groups and hide from right to left
            let totalWidth = 0;
            const visibleGroups = [];
            
            // Go from left to right and collect groups that fit
            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                const groupWidth = group.offsetWidth;
                const neededWidth = totalWidth + groupWidth + (totalWidth > 0 ? gap : 0);
                
                // Add a larger safety margin (16px) to prevent edge cases and ensure groups don't overlap badge
                // This accounts for rounding errors and ensures groups stay well clear of the badge
                if (neededWidth + 16 <= availableWidth) {
                    totalWidth = neededWidth;
                    visibleGroups.push(i);
                } else {
                    break; // Stop when we find a group that doesn't fit
                }
            }
            
            // Hide all groups that don't fit
            groups.forEach((group, index) => {
                if (!visibleGroups.includes(index)) {
                    group.style.display = 'none';
                }
            });
        }
        
        // Adjust banner groups on load and resize
        function initBannerGroups() {
            // Wait a bit longer to ensure badge is fully rendered
            setTimeout(adjustBannerGroups, 150);
            window.addEventListener('resize', function() {
                setTimeout(adjustBannerGroups, 100);
            });
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBannerGroups);
        } else {
            initBannerGroups();
        }
        
        // Adjust after HTMX updates
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'leaderboard-view' || event.target.closest('#leaderboard-view')) {
                // Wait longer after HTMX swap to ensure badge is rendered
                setTimeout(adjustBannerGroups, 150);
            }
        });
        
    </script>
</body>
</html>


