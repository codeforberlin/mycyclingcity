<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    leaderboard_page.html
     @author  Roland Rutz
     @note    This code was developed with the assistance of AI (LLMs).
-->

{% load i18n l10n leaderboard_filters %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Kiosk-Rangliste" %}</title>
    {% url 'favicon' as favicon_url %}
    <link rel="icon" type="image/png" href="{{ favicon_url }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        @keyframes pulse-ring {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .trophy-badge {
            transform: rotate(12deg);
        }
        .progress-bar {
            height: 2px;
            transition: width 0.1s linear;
        }
        /* Activity Toast System (Activity Chips) */
        .activity-toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000 !important;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
            pointer-events: none;
        }

        .activity-toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            pointer-events: auto;
            animation: toastSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transition: opacity 0.3s, transform 0.3s;
        }

        .activity-toast.fade-out {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .activity-toast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .activity-toast-icon {
            font-size: 18px;
        }

        .activity-toast-title {
            font-weight: 600;
            font-size: 13px;
            color: #1a1a1a;
        }

        .activity-toast-body {
            font-size: 12px;
            color: #4a4a4a;
            line-height: 1.4;
        }

        .activity-toast-cyclist {
            font-weight: 600;
            color: #007bff;
        }

        .activity-toast-distance {
            font-weight: 600;
            color: #28a745;
        }

        /* Hidden ticker for data source */
        #ticker-data-source {
            display: none;
        }

        /* ============================================
           Mobile-Only Overrides (max-width: 1023px)
           Protects Kiosk Mode - Desktop remains untouched
           ============================================ */
        @media screen and (max-width: 1023px) {
            /* Root Scaling: Scale up all rem-based elements for mobile */
            html {
                font-size: 110%; /* Scales all rem-based elements up */
            }

            /* Typography: Ensure minimum readable size for mobile */
            body {
                font-size: 16px; /* Minimum readable size for mobile */
                line-height: 1.5;
            }

            /* Map optimization: Full height with absolute positioning to remove white gap */
            #map {
                height: 100vh !important; /* Full height */
                width: 100vw !important;
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                padding: 0;
            }

            /* Map view: Full screen on mobile */
            #map-view {
                overflow: hidden;
            }

            /* Leaderboard view: Enable scrolling on mobile */
            #leaderboard-view {
                overflow-y: auto;
                overflow-x: hidden;
            }

            /* Banner: Adjust height for mobile */
            .h-\[20vh\] {
                min-height: 100px;
            }

            /* Main content: Better mobile layout */
            #leaderboard-content {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Footer: Adjust height for mobile */
            .h-\[5vh\] {
                min-height: 40px;
            }

            /* Touch targets: Increase size for buttons and interactive elements */
            button, a, select, input {
                min-height: 44px; /* Touch-friendly minimum height */
                min-width: 44px;
                padding: 15px 25px; /* Larger padding for better touch targets */
                font-size: 16px; /* Ensure readable text */
            }

            /* Activity toasts: Better mobile visibility */
            .activity-toast-container {
                max-width: 280px;
                top: 10px;
                right: 10px;
            }

            /* Banner content: Better mobile padding */
            .px-6 {
                padding-left: 20px; /* Increased padding */
                padding-right: 20px;
            }

            /* Small text blocks and labels: Ensure minimum readable size */
            label, .text-sm {
                font-size: 14px; /* Minimum readable size for labels */
            }
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-slate-900 text-white">
    <!-- Leaderboard View -->
    <div id="leaderboard-view" class="h-full w-full flex flex-col">
            <!-- Header: Parent Group Banner (20vh) -->
            <div class="h-[20vh] bg-gradient-to-r from-slate-800 to-slate-900 border-b border-slate-700 flex items-center justify-center relative overflow-hidden px-6">
                <div id="banner-content"
                     hx-get="{% url 'leaderboard:leaderboard_page' %}?banner_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
                     hx-trigger="every {{ KIOSK_BANNER_UPDATE_INTERVAL }}s"
                     hx-swap="innerHTML"
                     hx-target="this">
                    {% include 'leaderboard/partials/banner.html' %}
                </div>
            </div>
            
            <!-- Main: Group Grid (75vh) -->
            <div id="leaderboard-content" class="flex-1 overflow-hidden" 
                 hx-get="{% url 'leaderboard:leaderboard_page' %}{% if current_filter %}?group={{ current_filter|urlencode }}{% endif %}{% if sort_by and sort_by != 'daily' %}{% if current_filter %}&{% else %}?{% endif %}sort={{ sort_by|urlencode }}{% endif %}" 
                 hx-trigger="every {{ KIOSK_CONTENT_UPDATE_INTERVAL }}s, activityCyclistCountChanged from:body" 
                 hx-swap="innerHTML" 
                 hx-target="this">
                {% include 'leaderboard/partials/content.html' %}
            </div>
            
            <!-- Footer: Statistics (5vh) -->
            <div class="h-[5vh] bg-slate-800 border-t border-slate-700"
                 id="leaderboard-footer"
                 hx-get="{% url 'leaderboard:leaderboard_page' %}?footer_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
                 hx-trigger="every {{ KIOSK_FOOTER_UPDATE_INTERVAL }}s, activityCyclistCountChanged from:body"
                 hx-swap="innerHTML"
                 hx-target="this">
                {% include 'leaderboard/partials/footer.html' %}
            </div>
        </div>

    <!-- Hidden ticker for data source (Activity Chips read from here) -->
    <div id="ticker-data-source"
         hx-get="{% url 'leaderboard:leaderboard_page' %}?ticker_only=true{% if current_filter %}&group={{ current_filter|urlencode }}{% endif %}{% if sort_by %}&sort={{ sort_by|urlencode }}{% endif %}"
         hx-trigger="every {{ KIOSK_TICKER_UPDATE_INTERVAL }}s"
         hx-swap="innerHTML"
         hx-target="this">
        {% include 'leaderboard/partials/ticker.html' %}
    </div>

    <!-- Activity Toast Container (Activity Chips) -->
    <div class="activity-toast-container" id="activity-toast-container"></div>
    
    <script>
        
        // Activity Toast System (Activity Chips)
        // ============================================
        var maxToasts = 5; // Maximum number of toasts in toast mode
        var toastDuration = 8000; // 8 seconds (auto-remove after this time)
        var lastTickerData = {};
        var previousActiveCyclistCount = -1;

        // Format number in German format (e.g., 1234.56 -> "1.234,56")
        function formatNumberDE(num, decimals) {
            if (num === null || num === undefined || isNaN(num)) return '0,00';
            var numStr = parseFloat(num).toFixed(decimals);
            var parts = numStr.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return parts.join(',');
        }

        // Sort toasts by session_km (descending - highest first)
        function sortActivityToasts() {
            var container = document.getElementById('activity-toast-container');
            if (!container) return;

            var toasts = Array.from(container.querySelectorAll('.activity-toast'));
            if (toasts.length === 0) return;

            // Sort by session_km (extract from distance span)
            toasts.sort(function(a, b) {
                var aDistanceSpan = a.querySelector('.activity-toast-distance');
                var bDistanceSpan = b.querySelector('.activity-toast-distance');
                
                if (!aDistanceSpan || !bDistanceSpan) return 0;
                
                // Extract km value from text (format: "X.XX km")
                var aKmText = aDistanceSpan.textContent.replace(' km', '').trim();
                var bKmText = bDistanceSpan.textContent.replace(' km', '').trim();
                
                // Parse German number format (e.g., "1.234,56" -> 1234.56)
                var aKm = parseFloat(aKmText.replace(/\./g, '').replace(',', '.'));
                var bKm = parseFloat(bKmText.replace(/\./g, '').replace(',', '.'));
                
                // Sort descending (highest km first)
                return bKm - aKm;
            });

            // Re-append sorted toasts
            toasts.forEach(function(toast) {
                container.appendChild(toast);
            });
        }

        function createActivityToast(cyclist) {
            var container = document.getElementById('activity-toast-container');
            if (!container) return;

            // Create unique key for this cyclist
            var cyclistKey = cyclist.user_id + '|' + (cyclist.group_short_name || '');
            
            // Check if a toast for this cyclist already exists
            var existingToasts = container.querySelectorAll('.activity-toast');
            var toastExists = false;
            var existingToast = null;
            for (var i = 0; i < existingToasts.length; i++) {
                var toastBody = existingToasts[i].querySelector('.activity-toast-body');
                if (toastBody && toastBody.textContent.includes(cyclist.user_id)) {
                    // Toast for this cyclist already exists - update it instead of creating new one
                    existingToast = existingToasts[i];
                    var distanceSpan = existingToast.querySelector('.activity-toast-distance');
                    if (distanceSpan) {
                        distanceSpan.textContent = formatNumberDE(cyclist.session_km, 2) + ' km';
                    }
                    toastExists = true;
                    break;
                }
            }
            
            // If toast already exists, update and re-sort
            if (toastExists) {
                sortActivityToasts();
                return;
            }

            // In toast mode, limit to maxToasts (remove lowest km if needed)
            var currentToasts = container.querySelectorAll('.activity-toast');
            if (currentToasts.length >= maxToasts) {
                // Sort current toasts to find the one with lowest km
                var toastsArray = Array.from(currentToasts);
                toastsArray.sort(function(a, b) {
                    var aDistanceSpan = a.querySelector('.activity-toast-distance');
                    var bDistanceSpan = b.querySelector('.activity-toast-distance');
                    
                    if (!aDistanceSpan || !bDistanceSpan) return 0;
                    
                    var aKmText = aDistanceSpan.textContent.replace(' km', '').trim();
                    var bKmText = bDistanceSpan.textContent.replace(' km', '').trim();
                    
                    var aKm = parseFloat(aKmText.replace(/\./g, '').replace(',', '.'));
                    var bKm = parseFloat(bKmText.replace(/\./g, '').replace(',', '.'));
                    
                    return aKm - bKm; // Ascending to find lowest
                });
                
                // Remove the toast with lowest km
                var lowestToast = toastsArray[0];
                if (lowestToast) {
                    // Only remove if new cyclist has more km
                    var newKm = cyclist.session_km;
                    var lowestKmText = lowestToast.querySelector('.activity-toast-distance').textContent.replace(' km', '').trim();
                    var lowestKm = parseFloat(lowestKmText.replace(/\./g, '').replace(',', '.'));
                    
                    if (newKm > lowestKm) {
                        lowestToast.classList.add('fade-out');
                        setTimeout(function() {
                            if (lowestToast.parentNode) {
                                lowestToast.remove();
                            }
                        }, 300);
                    } else {
                        // New cyclist has fewer km, don't add
                        return;
                    }
                }
            }

            var toast = document.createElement('div');
            toast.className = 'activity-toast';
            toast.setAttribute('data-cyclist-key', cyclistKey);
            toast.setAttribute('data-session-km', cyclist.session_km);

            var icon = 'ðŸš´';
            var title = '{% trans "Aktuell radelnd" %}';
            var body = cyclist.user_id;
            if (cyclist.group_short_name) {
                body += ' (' + cyclist.group_short_name + ')';
            }
            body += ' - <span class="activity-toast-distance">' + formatNumberDE(cyclist.session_km, 2) + ' km</span>';

            toast.innerHTML =
                '<div class="activity-toast-header">' +
                '<span class="activity-toast-icon">' + icon + '</span>' +
                '<span class="activity-toast-title">' + title + '</span>' +
                '</div>' +
                '<div class="activity-toast-body">' + body + '</div>';

            container.appendChild(toast);
            
            // Sort after adding
            sortActivityToasts();

            // Auto-remove after duration
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.classList.add('fade-out');
                    setTimeout(function() {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, toastDuration);
        }

        // Fetch ticker data and create Activity Toasts
        function updateActivityToasts() {
            // Fetch fresh data directly from server (like in map)
            // Use the dedicated ticker endpoint for fresh session data
            // This endpoint reads current session kilometers from the database
            var url = "{% url 'leaderboard:leaderboard_ticker' %}";
            {% if current_filter %}
            // leaderboard_ticker accepts group_id (tries as ID first, then as name)
            url += "?group_id={{ current_filter|urlencode }}";
            {% endif %}

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.text();
                })
                .then(html => {
                    // Create a temporary DOM element to parse the HTML
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    var tickerItems = tempDiv.querySelectorAll('span');
                    var currentActiveCyclistCount = 0;
                    var hasActiveCyclists = false;

                    // Check if there are active cyclists (not just "Bereit zum Start" message)
                    tickerItems.forEach(function(item) {
                        var text = item.textContent || '';
                        var hasUserId = item.querySelector('strong');
                        if (hasUserId && !text.includes('Bereit zum Start')) {
                            hasActiveCyclists = true;
                            currentActiveCyclistCount++;
                        }
                    });

                    // Update cyclist count and trigger event if changed
                    if (currentActiveCyclistCount !== previousActiveCyclistCount) {
                        var oldCount = previousActiveCyclistCount;
                        previousActiveCyclistCount = currentActiveCyclistCount;
                        
                        // Dispatch custom event to trigger updates
                        var updateEvent = new CustomEvent('activityCyclistCountChanged', {
                            bubbles: true,
                            detail: { 
                                previousCount: oldCount,
                                currentCount: currentActiveCyclistCount 
                            }
                        });
                        document.body.dispatchEvent(updateEvent);
                    }

                    if (!hasActiveCyclists) {
                        // No active cyclists - clear all toasts
                        var container = document.getElementById('activity-toast-container');
                        if (container) {
                            var toasts = container.querySelectorAll('.activity-toast');
                            toasts.forEach(function(toast) {
                                toast.classList.add('fade-out');
                                setTimeout(function() {
                                    if (toast.parentNode) {
                                        toast.remove();
                                    }
                                }, 300);
                            });
                        }
                        return;
                    }

                    // Process each cyclist from ticker
                    tickerItems.forEach(function(item) {
                        var text = item.textContent || '';
                        var hasUserId = item.querySelector('strong');
                        
                        // Skip if it's the "Bereit zum Start" message
                        if (!hasUserId || text.includes('Bereit zum Start')) {
                            return;
                        }

                        // Extract cyclist data
                        var userId = hasUserId.textContent.trim();
                        var groupShortName = null;
                        var sessionKm = 0;

                        // Extract group name if present (in parentheses)
                        var groupMatch = text.match(/\(([^)]+)\)/);
                        if (groupMatch) {
                            groupShortName = groupMatch[1];
                        }

                        // Extract km value
                        // Handle German format: "1.234,56 km" -> 1234.56
                        var kmMatch = text.match(/([\d.,]+)\s*km/i);
                        if (kmMatch) {
                            var kmStr = kmMatch[1];
                            // German format: dots are thousands, comma is decimal
                            // Remove dots (thousands separators) and replace comma with dot
                            sessionKm = parseFloat(kmStr.replace(/\./g, '').replace(',', '.'));
                        }

                        var cyclist = {
                            user_id: userId,
                            group_short_name: groupShortName,
                            session_km: sessionKm
                        };

                        // Check if we should show/create a toast for this cyclist
                        var key = cyclist.user_id + '|' + (cyclist.group_short_name || '');
                        var lastKm = lastTickerData[key];
                        var shouldShowToast = false;
                        
                        if (!lastKm) {
                            // First time seeing this cyclist - always show toast
                            shouldShowToast = true;
                        } else if (Math.abs(cyclist.session_km - lastKm) > 0.1) {
                            // Kilometers have increased significantly - show toast
                            shouldShowToast = true;
                        } else {
                            // Check if a toast for this cyclist is already visible
                            var container = document.getElementById('activity-toast-container');
                            if (container) {
                                var existingToasts = container.querySelectorAll('.activity-toast');
                                var toastVisible = false;
                                for (var i = 0; i < existingToasts.length; i++) {
                                    var toastBody = existingToasts[i].querySelector('.activity-toast-body');
                                    if (toastBody && toastBody.textContent.includes(cyclist.user_id)) {
                                        toastVisible = true;
                                        break;
                                    }
                                }
                                // If no toast is visible for this cyclist, show one even if km hasn't changed much
                                // This ensures all active cyclists get a toast
                                if (!toastVisible) {
                                    shouldShowToast = true;
                                }
                            }
                        }
                        
                        if (shouldShowToast) {
                            createActivityToast(cyclist);
                            lastTickerData[key] = cyclist.session_km;
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching ticker data:', error);
                });
        }

        // Update Activity Toasts after HTMX updates
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'ticker-data-source') {
                // Wait a bit to ensure content is rendered
                requestAnimationFrame(function() {
                    updateActivityToasts();
                });
            }
        });

        // Update Activity Toasts periodically (every 15 seconds)
        // This is independent of HTMX updates and ensures frequent updates
        // since kilometer updates come in every ~10 seconds
        var activityToastRefreshInterval = 15; // 15 seconds
        setInterval(updateActivityToasts, activityToastRefreshInterval * 1000);

        // Initial update on page load
        function initializeActivityToasts() {
            setTimeout(function() {
                updateActivityToasts();
                previousActiveCyclistCount = 0; // Will be set correctly by updateActivityToasts
            }, 2000); // Initial delay of 2 seconds (like in map)
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeActivityToasts);
        } else {
            initializeActivityToasts();
        }
        
        // Dynamic banner group visibility based on viewport width
        function adjustBannerGroups() {
            const bannerContainer = document.getElementById('banner-groups');
            if (!bannerContainer) return;
            
            const groups = bannerContainer.querySelectorAll('.banner-group-item');
            if (groups.length === 0) return;
            
            // Get the parent container (the banner div)
            const bannerParent = bannerContainer.parentElement;
            if (!bannerParent) return;
            
            // Reset all groups to visible first
            groups.forEach(group => {
                group.style.display = '';
            });
            
            // Force a reflow to get accurate measurements
            bannerContainer.offsetHeight;
            
            // Get actual container dimensions
            const containerRect = bannerParent.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerLeft = containerRect.left;
            const containerRight = containerRect.right;
            
            // Get container padding
            const containerStyle = window.getComputedStyle(bannerParent);
            const paddingLeft = parseFloat(containerStyle.paddingLeft) || 0;
            const paddingRight = parseFloat(containerStyle.paddingRight) || 0;
            
            // Calculate trophy badge space more accurately
            const trophyBadge = document.querySelector('.trophy-badge');
            let badgeRightSpace = 0;
            if (trophyBadge) {
                const badgeRect = trophyBadge.getBoundingClientRect();
                const containerRect = bannerParent.getBoundingClientRect();
                // Calculate space from left edge of badge to right edge of container
                const badgeLeft = badgeRect.left;
                const badgeRight = badgeRect.right;
                const containerRight = containerRect.right;
                // Space needed: from container right edge to badge left edge, plus badge width, plus extra margin
                badgeRightSpace = containerRight - badgeLeft + 32; // 32px extra margin for safety
            }
            
            // Available width: container width minus badge space minus both paddings
            // No extra margin needed since groups start from left (justify-start)
            const availableWidth = containerWidth - badgeRightSpace - paddingLeft - paddingRight;
            const gap = 24; // gap-6 = 1.5rem = 24px
            
            // Measure all groups and hide from right to left
            let totalWidth = 0;
            const visibleGroups = [];
            
            // Go from left to right and collect groups that fit
            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                const groupWidth = group.offsetWidth;
                const neededWidth = totalWidth + groupWidth + (totalWidth > 0 ? gap : 0);
                
                // Add a larger safety margin (16px) to prevent edge cases and ensure groups don't overlap badge
                // This accounts for rounding errors and ensures groups stay well clear of the badge
                if (neededWidth + 16 <= availableWidth) {
                    totalWidth = neededWidth;
                    visibleGroups.push(i);
                } else {
                    break; // Stop when we find a group that doesn't fit
                }
            }
            
            // Hide all groups that don't fit
            groups.forEach((group, index) => {
                if (!visibleGroups.includes(index)) {
                    group.style.display = 'none';
                }
            });
        }
        
        // Adjust banner groups on load and resize
        function initBannerGroups() {
            // Wait a bit longer to ensure badge is fully rendered
            setTimeout(adjustBannerGroups, 150);
            window.addEventListener('resize', function() {
                setTimeout(adjustBannerGroups, 100);
            });
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBannerGroups);
        } else {
            initBannerGroups();
        }
        
        // Adjust after HTMX updates
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'leaderboard-view' || event.target.closest('#leaderboard-view')) {
                // Wait longer after HTMX swap to ensure badge is rendered
                setTimeout(adjustBannerGroups, 150);
            }
        });
        
    </script>
</body>
</html>


