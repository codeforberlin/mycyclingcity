<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    base_site.html
     @author  Roland Rutz
     @note    This code was developed with the assistance of AI (LLMs).
-->

{% extends "admin/base.html" %}
{% load i18n static %}

{% block title %}{% if subtitle %}{{ subtitle }} | {% endif %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="icon" type="image/png" href="{% url 'favicon' %}">
{% endblock %}

{% block branding %}
<h1 id="site-name">
    <a href="{% url 'admin:index' %}">{{ site_header|default:_('Django administration') }}</a>
    <span style="font-size: 0.7em; font-weight: normal; color: #999; margin-left: 10px;">v{{ PROJECT_VERSION|default:"dev" }}</span>
</h1>
{% endblock %}

{% block nav-global %}{% endblock %}

{% block extrastyle %}
{{ block.super }}
{% load static %}
<script src="{% static 'js/timezone-converter.js' %}"></script>
<script>
/**
 * Timezone Cookie Setup for Django Admin
 * 
 * This script detects the browser's timezone and stores it in a cookie
 * named 'django_timezone' so the backend middleware can use it.
 */
(function() {
    'use strict';
    
    const COOKIE_NAME = 'django_timezone';
    const COOKIE_MAX_AGE = 365 * 24 * 60 * 60; // 1 year in seconds
    const COOKIE_PATH = '/'; // Use root path so cookie is available for all admin paths including /de/admin/
    
    /**
     * Set a cookie with the given name, value, and options
     */
    function setCookie(name, value, maxAge, path) {
        // Get secure flag from current page protocol
        const isSecure = window.location.protocol === 'https:';
        const secureFlag = isSecure ? '; Secure' : '';
        
        // Set SameSite attribute (Lax for better compatibility)
        const sameSite = '; SameSite=Lax';
        
        document.cookie = `${name}=${encodeURIComponent(value)}; max-age=${maxAge}; path=${path}${secureFlag}${sameSite}`;
    }
    
    /**
     * Get cookie value by name
     */
    function getCookie(name) {
        const nameEQ = name + '=';
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i];
            while (cookie.charAt(0) === ' ') {
                cookie = cookie.substring(1, cookie.length);
            }
            if (cookie.indexOf(nameEQ) === 0) {
                return decodeURIComponent(cookie.substring(nameEQ.length, cookie.length));
            }
        }
        return null;
    }
    
    /**
     * Get browser's timezone
     */
    function getBrowserTimezone() {
        try {
            return Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (e) {
            console.warn('Could not detect browser timezone:', e);
            return null;
        }
    }
    
    /**
     * Initialize timezone cookie
     */
    function initTimezoneCookie() {
        const browserTimezone = getBrowserTimezone();
        if (!browserTimezone) {
            return; // Cannot detect timezone, skip
        }
        
        const currentCookie = getCookie(COOKIE_NAME);
        
        // Set cookie if not present or if timezone has changed
        if (!currentCookie || currentCookie !== browserTimezone) {
            setCookie(COOKIE_NAME, browserTimezone, COOKIE_MAX_AGE, COOKIE_PATH);
            
            // If timezone changed, reload page to apply new timezone immediately
            if (currentCookie && currentCookie !== browserTimezone) {
                // Small delay to ensure cookie is set before reload
                setTimeout(function() {
                    window.location.reload();
                }, 100);
            }
        }
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTimezoneCookie);
    } else {
        initTimezoneCookie();
    }
})();
</script>
<style>
    .language-switcher {
        display: inline-block;
        margin-left: 15px;
        padding-left: 15px;
        border-left: 1px solid #ddd;
    }
    .language-switcher form {
        display: inline-block;
        margin: 0;
        vertical-align: middle;
    }
    .language-switcher select {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 500;
        background: white;
        color: #417690;
        cursor: pointer;
        min-width: 100px;
    }
    .language-switcher select:hover {
        background: #f0f0f0;
    }
    .language-switcher select:focus {
        outline: none;
        border-color: #417690;
        box-shadow: 0 0 0 2px rgba(65, 118, 144, 0.2);
    }
</style>
{% endblock %}

{% block userlinks %}
    {% if site_url %}
        <a href="{{ site_url }}">{% trans 'View site' %}</a> /
    {% endif %}
    {% if user.is_active and user.is_staff %}
        {% url 'django-admindocs-docroot' as docsroot %}
        {% if docsroot %}
            <a href="{{ docsroot }}">{% trans 'Documentation' %}</a> /
        {% endif %}
    {% endif %}
    {% if user.has_usable_password %}
    <a href="{% url 'admin:password_change' %}">{% trans 'Change password' %}</a> /
    {% endif %}
    <!-- Language Switcher -->
    <span class="language-switcher">
        <form method="post" action="/i18n/setlang/" id="admin-language-form" style="display: inline-block; margin: 0;">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            {% get_current_language as current_lang %}
            <select name="language" onchange="document.getElementById('admin-language-form').submit();">
                {% for lang_code, lang_name in LANGUAGES %}
                    <option value="{{ lang_code }}" {% if lang_code == current_lang or lang_code|slice:":2" == current_lang|slice:":2" %}selected{% endif %}>
                        {{ lang_name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </span>
    /
    {% get_current_language as current_lang %}
    {% if current_lang == 'en' %}
        <a href="https://codeforberlin.github.io/mycyclingcity/en/" target="_blank" title="{% trans 'Documentation' %}">ðŸ“š {% trans 'Documentation' %}</a> /
    {% else %}
        <a href="https://codeforberlin.github.io/mycyclingcity/" target="_blank" title="{% trans 'Documentation' %}">ðŸ“š {% trans 'Documentation' %}</a> /
    {% endif %}
    <form method="post" action="{% url 'admin:logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" style="background: none; border: none; padding: 0; margin: 0; color: inherit; text-decoration: underline; cursor: pointer; font: inherit;">{% trans 'Log out' %}</button>
    </form>
{% endblock %}
