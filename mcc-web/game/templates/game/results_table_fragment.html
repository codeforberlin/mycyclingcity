<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    results_table_fragment.html
     @author  Roland Rutz
     @note    This code was developed with the assistance of AI (LLMs).
-->

{# mcc/game/templates/game/results_table_fragment.html #}
{% load static %}
{% load i18n %}

<tbody id="resultsTableBody"
    hx-get="{% url 'game:render_results_table' %}"
    hx-target="this"
    hx-swap="outerHTML"
    hx-include="#targetKm" 
    
    {# Setze den Trigger basierend auf Spielstatus und Raum-Status #}
    {% if game_is_active and not is_game_stopped %}
        {# Spiel lÃ¤uft: Alle 10 Sekunden aktualisieren + refresh event #}
        hx-trigger="every 10s, refresh" 
    {% elif room_code %}
        {# Raum aktiv, aber Spiel noch nicht gestartet: Alle 3 Sekunden aktualisieren fÃ¼r Echtzeit-Synchronisation #}
        hx-trigger="every 3s, refresh" 
    {% else %}
        {# Kein Raum, kein aktives Spiel: Nur bei refresh event #}
        hx-trigger="refresh" 
    {% endif %}
    
    {# CRITICAL: Data attributes for JS control and winner check #}
    data-game-active="{{ game_is_active|yesno:'true,false' }}"
    data-game-stopped="{{ is_game_stopped|yesno:'true,false' }}"
    data-new-winners="{{ new_winners|join:',' }}"
    data-room-code="{{ room_code|default:'' }}"
    data-target-km="{% if target_km > 0 %}{{ target_km|floatformat:0 }}{% else %}0{% endif %}"
    data-is-master="{{ is_master|yesno:'true,false' }}"
    >
    {% if game_results %}
        {% for result in game_results %}
        {% with rank=forloop.counter %}
        {% with is_winner=False %}
            {% if result.cyclist_name in winner_names %}
                {% with is_winner=True %}{% endwith %}
            {% endif %}
        {% endwith %}
        
        <tr data-cyclist="{{ result.cyclist_name }}" data-device="{{ result.device_name }}" 
            class="{% if is_winner %}winner-row {% endif %}{% if is_game_stopped and rank == 1 %}rank-1{% elif is_game_stopped and rank == 2 %}rank-2{% elif is_game_stopped and rank == 3 %}rank-3{% endif %}{% if result.is_master_cyclist %} master-row{% endif %}{% if result.is_own_assignment %} own-assignment{% endif %}">
            {# Rank column: Medals when game is stopped, numbers when game is running #}
            <td class="rank-cell">
                {% if is_game_stopped %}
                    {# Show medals for top 3 when game is stopped #}
                    {% if rank == 1 %}
                        <span class="medal">ðŸ¥‡</span>
                    {% elif rank == 2 %}
                        <span class="medal">ðŸ¥ˆ</span>
                    {% elif rank == 3 %}
                        <span class="medal">ðŸ¥‰</span>
                    {% else %}
                        {{ rank }}.
                    {% endif %}
                {% else %}
                    {# Show numbers when game is running #}
                    {{ rank }}.
                {% endif %}
            </td>
            
            {# Cyclist name with winner badge #}
            <td>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <span>{{ result.cyclist_name }}</span>
                    {% if is_winner %}
                        <span class="winner-badge">{% trans "Gewinner!" %}</span>
                    {% endif %}
                    {% if is_master and room_code %}
                        <button onclick="transferMasterTo('{{ result.cyclist_name }}')"
                                title="{% trans 'Spielleiter-Rolle an diesen Teilnehmer Ã¼bertragen' %}"
                                style="background-color: #ffc107; color: #333; border: none; border-radius: 3px; padding: 2px 6px; font-size: 0.7em; cursor: pointer; margin-left: 5px;">
                            ðŸ‘‘
                        </button>
                    {% endif %}
                </div>
            </td>
            
            <td>{{ result.device_name }}</td>
            
            {# Kilometers with progress bar if target is set #}
            <td>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="font-weight: bold; margin-bottom: 3px;">{{ result.distance_km|floatformat:2 }} km</div>
                    {% if target_km > 0 %}
                        <div class="progress-container">
                            <div class="progress-bar {% if result.progress_percent >= 100 %}progress-bar-full{% endif %}" 
                                 style="width: {% if result.progress_percent > 100 %}100{% else %}{{ result.progress_percent|floatformat:1 }}{% endif %}%;">
                            </div>
                            <div class="progress-text">
                                {% if result.progress_percent >= 100 %}
                                    100% âœ“
                                {% else %}
                                    {{ result.progress_percent|floatformat:0 }}%
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </td>
            
            <td>{{ result.coins|floatformat:0 }}</td>
            <td>
                {% if result.can_delete %}
                <button hx-post="{% url 'game:handle_assignment_form' %}"
                        hx-target="#resultsTableBody"
                        hx-swap="outerHTML"
                        hx-confirm="{% trans 'Sind Sie sicher, dass Sie die Zuweisung entfernen mÃ¶chten?' %}"
                        hx-vals='{"action": "remove", "cyclist": "{{ result.cyclist_name }}"}'
                        {% if room_code %}
                        hx-on::after-request="if(event.detail.successful) { setTimeout(() => htmx.trigger('#resultsTableBody', 'refresh'), 100); }"
                        {% endif %}
                        style="background-color: #dc3545; color: white; padding: 5px 8px; font-size: 0.8em;">
                    {% trans "Entfernen" %}
                </button>
                {% else %}
                <span style="color: #999; font-size: 0.8em;">{% trans "Nur Spielleiter" %}</span>
                {% endif %}
            </td>
        </tr>
        {% endwith %}
        {% endfor %}
    {% else %}
        <tr><td colspan="6" style="text-align:center;">{% trans "Warte auf Spielstart oder keine Zuweisungen aktiv." %}</td></tr>
    {% endif %}
</tbody>