<!DOCTYPE html>
<!-- Copyright (c) 2026 SAI-Lab / MyCyclingCity
     SPDX-License-Identifier: AGPL-3.0-or-later
     
     @file    mcc_game.html
     @author  Roland Rutz
     @note    This code was developed with the assistance of AI (LLMs).
-->

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCC Spiel: Kilometer-Challenge</title>
    {% load static %}
    {% load i18n %}
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* ... CSS bleibt unver√§ndert ... */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); flex: 1; }
        .header-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 10px; 
            position: relative;
        }
        .header-container .logo-left,
        .header-container .logo-right {
            flex-shrink: 0;
            min-width: 60px;
        }
        .header-container > div {
            text-align: center;
            min-width: 0; /* Allows text to shrink if needed */
        }
        h1 { color: #333; text-align: center; margin: 0; }
        .two-column-layout { display: flex; justify-content: space-between; gap: 20px; }
        .two-column-layout > div { flex: 1; display: flex; flex-direction: column; gap: 15px; align-items: center; text-align: center; }
        .controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .controls h3 { margin-top: 0; text-align: center; }
        .controls label { font-weight: bold; }
        select, input[type="range"], input[type="number"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .target-km-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: -10px 0 10px 0; align-items: start; }
        .target-km-option { display: flex; align-items: center; justify-content: flex-start; min-height: 32px; }
        .target-km-option input[type="checkbox"] { width: 24px; height: 24px; margin-right: 8px; cursor: pointer; flex-shrink: 0; }
        .target-km-option label { font-weight: normal; cursor: pointer; margin: 0; display: flex; align-items: center; white-space: nowrap; min-width: 50px; text-align: right; justify-content: flex-end; }
        .target-km-manual { 
            margin-top: 5px; 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .target-km-manual input[type="number"] { 
            margin: 0 auto; 
            display: block; 
            max-width: 200px; 
            width: 100%;
        }
        .assignments { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .top-controls { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: opacity 0.3s ease, background-color 0.3s ease; }
        #startButton { background-color: #28a745; color: white; }
        #stopButton { background-color: #dc3545; color: white; }
        #endSessionButton { background-color: #f4a261; color: white; }
        /* Button States - Simple and Clear */
        #startButton.inactive,
        #stopButton.inactive { 
            opacity: 0.4 !important;
            cursor: not-allowed !important;
            background-color: #6c757d !important;
            pointer-events: none !important;
        }
        #startButton:not(.inactive) {
            opacity: 1 !important;
            background-color: #28a745 !important;
            pointer-events: auto !important;
        }
        #stopButton:not(.inactive) {
            opacity: 1 !important;
            background-color: #dc3545 !important;
            pointer-events: auto !important;
        }
        #startButton:not(.inactive):hover { 
            background-color: #218838; 
        }
        #stopButton:not(.inactive):hover { 
            background-color: #c82333; 
        }
        #endSessionButton:hover { 
            background-color: #e76f51; 
        }
        /* Ensure disabled buttons look the same for non-master users */
        button[disabled]#startButton,
        button[disabled]#stopButton,
        button[disabled]#endSessionButton {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background-color: #6c757d !important;
            color: white !important;
            pointer-events: none !important;
        }
        #clearAssignmentsButton { background-color: #ffc107; color: #333; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .results-table th { background-color: #f2f2f2; }
        .rank-cell { font-weight: bold; font-size: 1.1em; }
        .medal { font-size: 1.5em; }
        .winner-badge { background-color: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 5px; }
        .progress-container { width: 100%; background-color: #e9ecef; border-radius: 10px; height: 20px; margin: 5px 0; position: relative; }
        .progress-bar { height: 100%; border-radius: 10px; transition: width 0.3s ease; min-height: 20px; width: auto !important; }
        .results-table td .progress-bar { width: auto !important; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75em; font-weight: bold; color: #333; z-index: 1; }
        .progress-bar-full { background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%); }
        tr.winner-row { background-color: #d4edda !important; }
        tr.rank-1 { background-color: #fff9e6; }
        tr.rank-2 { background-color: #f5f5f5; }
        tr.rank-3 { background-color: #faf0e6; }
        tr.master-row { background-color: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        tr.own-assignment { background-color: #e7f3ff !important; border-left: 4px solid #007bff !important; }
        tr.master-row.own-assignment { background-color: #d1ecf1 !important; border-left: 4px solid #17a2b8 !important; }
        .remove-checkbox { cursor: pointer; width: 20px; height: 20px; margin: 0 auto; display: block; }
        
        /* Information Hub Button - Global UI Layer */
        .info-hub-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .info-hub-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 1);
        }
        
        /* Information Hub Modal - Global UI Layer */
        .info-hub-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 20px;
        }
        .info-hub-modal-overlay.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .info-hub-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            max-width: 600px;
            max-height: 85vh;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .info-hub-header {
            padding: 28px 32px 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .info-hub-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0 0 12px 0;
        }
        .info-hub-version {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }
        .info-hub-version-label {
            font-weight: 500;
        }
        .info-hub-version-value {
            font-weight: 600;
            color: #007bff;
            font-family: 'Courier New', monospace;
        }
        .info-hub-body {
            padding: 24px 32px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .info-hub-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .info-hub-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }
        .info-hub-faq {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .info-hub-accordion-item {
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .info-hub-accordion-item:hover {
            border-color: rgba(0, 123, 255, 0.3);
        }
        .info-hub-accordion-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            background: rgba(255, 255, 255, 0.5);
            transition: background 0.2s;
        }
        .info-hub-accordion-header:hover {
            background: rgba(0, 123, 255, 0.05);
        }
        .info-hub-accordion-question {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
            flex: 1;
        }
        .info-hub-accordion-icon {
            font-size: 18px;
            color: #666;
            transition: transform 0.3s;
        }
        .info-hub-accordion-item.open .info-hub-accordion-icon {
            transform: rotate(180deg);
        }
        .info-hub-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 20px;
        }
        .info-hub-accordion-item.open .info-hub-accordion-content {
            max-height: 500px;
            padding: 0 20px 16px 20px;
        }
        .info-hub-accordion-answer {
            font-size: 14px;
            line-height: 1.6;
            color: #4a4a4a;
        }
        .info-hub-wiki-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        .info-hub-wiki-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        .info-hub-language-form {
            display: flex;
            width: 100%;
        }
        .info-hub-language-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .info-hub-language-select:hover {
            border-color: rgba(0, 123, 255, 0.3);
            background: rgba(255, 255, 255, 1);
        }
        .info-hub-footer {
            padding: 20px 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(0, 0, 0, 0.02);
        }
        .info-hub-footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        .info-hub-footer-link {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s;
        }
        .info-hub-footer-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        .info-hub-footer-separator {
            color: #ccc;
        }
        .info-hub-footer-copyright {
            color: #999;
        }
        .info-hub-footer-copyright a {
            color: #007bff;
            text-decoration: none;
        }
        .info-hub-footer-copyright a:hover {
            text-decoration: underline;
        }
        .info-hub-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 50%;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }
        .info-hub-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
            transform: rotate(90deg);
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); max-width: 90%; min-width: 300px; position: relative; }
        .modal-content h2 { font-size: 2.5em; color: #28a745; margin-top: 0; }
        .modal-content p { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 20px; }
        .modal-content img { max-width: 100%; height: auto; border-radius: 5px; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 2em; cursor: pointer; color: #aaa; }
        .logo-left, .logo-right { 
            max-height: 80px; 
            width: auto; 
            height: auto;
            object-fit: contain;
        }
        input[type="range"] { width: 90%; margin: 0 auto; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }

        /* ============================================
           Mobile-Only Overrides (max-width: 1023px)
           Protects Kiosk Mode - Desktop remains untouched
           ============================================ */
        @media screen and (max-width: 1023px) {
            /* Root Scaling: Scale up all rem-based elements for mobile */
            html {
                font-size: 110%; /* Scales all rem-based elements up */
            }

            /* Typography: Ensure minimum readable size for mobile */
            body {
                font-size: 16px; /* Minimum readable size for mobile */
                line-height: 1.5;
                margin: 10px;
            }

            /* Fluid layout: Convert fixed max-width to percentage */
            .container {
                max-width: 90%; /* Use percentage instead of fixed pixels */
                margin: 10px auto;
                padding: 20px; /* Increased padding */
            }

            /* Vertical stacking: Convert two-column layout to single column */
            .two-column-layout {
                flex-direction: column;
                gap: 20px;
            }

            .two-column-layout > div {
                width: 100%;
            }

            /* Assignments grid: Stack vertically on mobile */
            .assignments {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Touch targets: Increase size for buttons and interactive elements */
            button, select, input[type="number"], input[type="range"] {
                min-height: 44px; /* Touch-friendly minimum height */
                padding: 15px 25px; /* Larger padding for better touch targets */
                font-size: 16px; /* Ensure readable text */
            }

            /* Top controls: Better mobile layout */
            .top-controls {
                flex-direction: column;
                gap: 15px; /* Increased gap */
            }

            .top-controls button {
                width: 100%;
                padding: 15px 25px; /* Larger buttons */
            }

            /* Header container: Better mobile layout */
            /* Keep header-container as row layout even on mobile - logos stay left and right */
            .header-container {
                gap: 8px;
            }

            h1 {
                font-size: 24px; /* Larger heading */
            }

            .logo-left, .logo-right {
                max-height: 50px;
                min-width: 40px;
                max-width: 70px;
            }
            
            .header-container > div {
                font-size: 0.85em;
            }
            
            .header-container h1 {
                font-size: 18px;
            }
            
            .header-container p {
                font-size: 0.8em;
            }

            /* Controls section: Better mobile spacing */
            .controls {
                padding: 20px; /* Increased padding */
            }

            .controls h3 {
                font-size: 20px; /* Larger section headings */
            }

            .controls label {
                font-size: 16px; /* Larger labels */
                margin-bottom: 10px;
            }

            /* Target KM options: Keep 3 columns on mobile */
            .target-km-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .target-km-option input[type="checkbox"] {
                width: 28px; /* Larger touch target */
                height: 28px;
            }

            /* Results table: Better mobile readability */
            .results-table {
                font-size: 15px; /* Increased from 14px */
            }

            .results-table th, .results-table td {
                padding: 15px 10px; /* Increased padding */
                font-size: 15px; /* Ensure readable table text */
            }

            .results-table th {
                font-size: 16px; /* Larger table headers */
            }

            /* Small text blocks and labels: Ensure minimum readable size */
            label, p {
                font-size: 16px; /* Minimum readable size */
            }

            /* Modal: Better mobile sizing */
            .modal-content {
                max-width: 95%;
                padding: 30px 20px;
            }

            .modal-content h2 {
                font-size: 2em;
            }

            .modal-content p {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container">
        <img id="logo-left" class="logo-left" src="{% static logo_left %}" alt="{% trans 'Logo links' %}">
        <div>
            <h1>MyCyclingCity</h1>
            <p style="text-align: center; margin: 0;">{% trans "Kilometer-Challenge" %}</p>
        </div>
        <img id="logo-right" class="logo-right" src="{% static logo_right %}" alt="{% trans 'Logo rechts' %}">
    </div>

    <p style="text-align: center;">{% trans "Radler und Ger√§te zuweisen ‚Üí Spiel starten ‚Üí Kilometer sammeln!" %}</p>

    {% if room_code %}
    <div id="roomInfo" style="background-color: #d4edda; border: 2px solid #28a745; border-radius: 6px; padding: 10px; margin: 10px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;">
            <div id="masterBadge" style="background-color: #ffc107; padding: 4px 8px; border-radius: 3px; font-size: 0.85em; display: {% if is_master %}inline-block{% else %}none{% endif %};">
                <strong>üëë {% trans "Spielleiter" %}</strong>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 0.9em; color: #155724; font-weight: bold; margin-bottom: 2px;">üè† {% trans "Raum" %}</div>
                <div style="font-size: 18px; font-weight: bold; color: #155724;">{{ room_code }}</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
            <img src="{% url 'game:room_qr_code' room_code %}" alt="{% trans 'QR-Code zum Beitreten' %}" style="max-width: 80px; height: 80px; border: 1px solid #28a745; border-radius: 3px; cursor: pointer;" title="{% trans 'QR-Code zum Beitreten' %}" onclick="this.style.maxWidth = this.style.maxWidth === '200px' ? '80px' : '200px'; this.style.height = this.style.height === '200px' ? '80px' : '200px';">
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button onclick="shareRoom('{{ room_url }}', '{{ room_code }}')" 
                        style="display: inline-block; padding: 6px 12px; background-color: #007bff; color: white; text-decoration: none; border: none; border-radius: 3px; font-weight: bold; font-size: 0.85em; white-space: nowrap; cursor: pointer;">
                    üì§ {% trans "Teilen" %}
                </button>
                <a href="{% url 'game:leave_room' %}" style="display: inline-block; padding: 6px 12px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 3px; font-weight: bold; font-size: 0.85em; white-space: nowrap;">
                    {% trans "Verlassen" %}
                </a>
                <div id="masterActions" style="display: {% if is_master %}inline-block{% else %}none{% endif %};">
                    <button hx-post="{% url 'game:end_room' %}"
                            hx-confirm="{% trans 'M√∂chten Sie den Raum wirklich beenden? Alle Teilnehmer werden getrennt.' %}"
                            hx-on::after-request="if(event.detail.successful) { window.location.href='{% url 'game:game_page' %}'; }"
                            style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 3px; font-weight: bold; cursor: pointer; font-size: 0.85em; white-space: nowrap; width: 100%;">
                        üèÅ {% trans "Beenden" %}
                    </button>
                </div>
            </div>
        </div>
        <div id="masterTip" style="width: 100%; font-size: 0.75em; color: #666; margin-top: 5px; display: {% if is_master %}block{% else %}none{% endif %};">
            <em>{% trans "Tipp: üëë neben Radlernamen = Spielleiter-Rolle √ºbertragen" %}</em>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; margin: 20px 0;">
        <h3>{% trans "Gemeinsam spielen" %}</h3>
        <p>{% trans "Erstelle einen Spiel-Raum, damit andere Radler an verschiedenen Orten die gleiche Tabelle sehen k√∂nnen." %}</p>
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
            <a href="{% url 'game:create_room' %}" style="display: inline-block; padding: 12px 24px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
                üè† {% trans "Raum erstellen" %}
            </a>
            <a href="{% url 'game:join_room' %}" style="display: inline-block; padding: 12px 24px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
                ‚ûï {% trans "Raum beitreten" %}
            </a>
        </div>
    </div>
    {% endif %}

    <div class="top-controls" id="gameButtonsContainer">
        {% csrf_token %}
        <script>
            // Debug: Check CSRF token
            document.addEventListener('DOMContentLoaded', function() {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                console.log('CSRF Token found:', csrfToken !== null, 'value:', csrfToken ? csrfToken.value.substring(0, 10) + '...' : 'N/A');
            });
        </script>

        {# Buttons are now loaded via HTMX fragment #}
        {% include 'game/partials/game_buttons.html' %}
    </div>

    <div>
        <table class="results-table">
            <thead>
                <tr>
                    <th style="width: 60px;">{% trans "Rang" %}</th>
                    <th>{% trans "Radler" %}</th>
                    <th>{% trans "Ger√§t" %}</th>
                    <th>{% trans "Kilometer (km)" %}</th>
                    <th>{% trans "MCC-Coins" %}</th>
                    <th>{% trans "Entfernen" %}</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody"
                 hx-get="{% url 'game:render_results_table' %}"
                 hx-target="this"
                 hx-swap="outerHTML"
                 hx-include="#targetKm"
                 {% if room_code %}
                 {# Wenn in einem Raum: Sofort laden und dann automatisch aktualisieren (alle 3 Sekunden) #}
                 hx-trigger="load, every 3s"
                 {% else %}
                 {# Kein Raum: Nur einmal beim Laden #}
                 hx-trigger="load once"
                 {% endif %}>
                {# Content is now fetched from the backend via HTMX #}
            </tbody>
        </table>
    </div>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">

    <div class="controls">
        <div class="two-column-layout">
            <div id="player-device-assignment">
                <h3>{% trans "Radler & Ger√§te zuweisen" %}</h3>

                <form hx-post="{% url 'game:handle_assignment_form' %}"
                      hx-target="#resultsTableBody"
                      hx-swap="outerHTML"
                      hx-vals='{"action": "add"}'
                      {% if room_code %}
                      hx-on::after-request="if(event.detail.successful) { setTimeout(() => htmx.trigger('#resultsTableBody', 'refresh'), 100); }"
                      {% endif %}>
                    {% csrf_token %}
                    <div class="assignments">
                        <select id="cyclistSelect" name="cyclist">
                            <option value="">{% trans "W√§hle einen Radler" %}</option>
                            {% for cyclist in cyclists %}
                            <option value="{{ cyclist.user_id }}">{{ cyclist.user_id }}</option>
                            {% endfor %}
                        </select>

                        <select id="deviceSelect" name="device">
                            <option value="">{% trans "W√§hle ein Ger√§t" %}</option>
                            {% for device in devices %}
                            <option value="{{ device.name }}">{{ device.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" style="margin-top: 10px;">{% trans "Zuweisung hinzuf√ºgen" %}</button>
                </form>

                {% if is_master or not room_code %}
                <button
                    hx-post="{% url 'game:handle_assignment_form' %}"
                    hx-target="#resultsTableBody"
                    hx-swap="outerHTML"
                    hx-vals='{"action": "clear"}'
                    hx-confirm="{% trans 'Sind Sie sicher, dass Sie alle Zuweisungen l√∂schen m√∂chten?' %}"
                    id="clearAssignmentsButton">{% trans "Alle Zuweisungen l√∂schen" %}</button>
                {% endif %}

            </div>

            <div>
                {% if is_master or not room_code %}
                <h3>{% trans "Zielkilometer (optional)" %}</h3>
                
                {# Checkbox options for quick selection #}
                <div class="target-km-options">
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm1" name="target_km_checkbox" value="1" onchange="handleTargetKmCheckbox(1)">
                        <label for="targetKm1">1 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm2" name="target_km_checkbox" value="2" onchange="handleTargetKmCheckbox(2)">
                        <label for="targetKm2">2 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm3" name="target_km_checkbox" value="3" onchange="handleTargetKmCheckbox(3)">
                        <label for="targetKm3">3 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm4" name="target_km_checkbox" value="4" onchange="handleTargetKmCheckbox(4)">
                        <label for="targetKm4">4 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm5" name="target_km_checkbox" value="5" onchange="handleTargetKmCheckbox(5)">
                        <label for="targetKm5">5 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm10" name="target_km_checkbox" value="10" onchange="handleTargetKmCheckbox(10)">
                        <label for="targetKm10">10 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm15" name="target_km_checkbox" value="15" onchange="handleTargetKmCheckbox(15)">
                        <label for="targetKm15">15 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm20" name="target_km_checkbox" value="20" onchange="handleTargetKmCheckbox(20)">
                        <label for="targetKm20">20 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm25" name="target_km_checkbox" value="25" onchange="handleTargetKmCheckbox(25)">
                        <label for="targetKm25">25 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm30" name="target_km_checkbox" value="30" onchange="handleTargetKmCheckbox(30)">
                        <label for="targetKm30">30 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm35" name="target_km_checkbox" value="35" onchange="handleTargetKmCheckbox(35)">
                        <label for="targetKm35">35 km</label>
                    </div>
                    <div class="target-km-option">
                        <input type="checkbox" id="targetKm40" name="target_km_checkbox" value="40" onchange="handleTargetKmCheckbox(40)">
                        <label for="targetKm40">40 km</label>
                    </div>
                </div>

                {# Manual input field #}
                <div class="target-km-manual">
                    <label for="targetKm" style="text-align:center; display: block; margin-bottom: 5px;">{% trans "Oder manuell eingeben" %}:</label>
                    <input type="number" 
                           id="targetKm" 
                           name="target_km" 
                           min="1" 
                           step="1"
                           placeholder="{% trans 'Ziel-km eingeben' %}" 
                           value="{% if current_target_km > 0 %}{{ current_target_km|floatformat:0 }}{% endif %}"
                           style="max-width: 200px; margin: 0 auto; display: block;"
                           hx-trigger="input changed delay:500ms"
                           hx-get="{% url 'game:render_results_table' %}"
                           hx-target="#resultsTableBody"
                           hx-swap="outerHTML"
                           hx-include="this"
                           oninput="handleTargetKmInput()"
                           onkeydown="return handleTargetKmKeydown(event)"
                           onpaste="handleTargetKmPaste(event)">
                </div>
                {% else %}
                {# Non-master view: show target but not editable - HTMX-updateable #}
                <div id="targetKmDisplayContainer"
                     hx-get="{% url 'game:render_target_km_display' %}"
                     hx-target="this"
                     hx-swap="innerHTML"
                     {% if room_code %}
                     {# Wenn in einem Raum: Sofort laden und dann automatisch aktualisieren (alle 3 Sekunden) #}
                     hx-trigger="load, every 3s"
                     {% else %}
                     {# Kein Raum: Nur einmal beim Laden #}
                     hx-trigger="load once"
                     {% endif %}>
                    {# Initial content - wird sofort durch HTMX ersetzt #}
                    <h3>{% trans "Zielkilometer" %}</h3>
                    {% if current_target_km > 0 %}
                    <p style="font-size: 20px; font-weight: bold; text-align: center; color: #28a745; margin: 20px 0;">
                        {{ current_target_km|floatformat:0 }} km
                    </p>
                    {% else %}
                    <p style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">
                        {% trans "Kein Ziel gesetzt" %}
                    </p>
                    {% endif %}
                    <p style="text-align: center; font-size: 0.9em; color: #666; margin-top: 10px;">
                        <em>{% trans "Nur der Spielleiter kann das Ziel √§ndern" %}</em>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Global Information Hub Button -->
<button class="info-hub-button" onclick="openInfoHubModal()" title="{% trans 'Information' %}">
    ‚Ñπ
</button>

<!-- Global Information Hub Modal -->
{% include "game/partials/info_modal.html" %}

<div id="winnerModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2>{% trans "Kilometerweltmeister!" %}</h2>
        <p id="winnerName"></p>
        <img id="winnerPhoto" src="{% static winner_photo %}" alt="{% trans 'Foto des Gewinners' %}">
    </div>
</div>

<script>
    const winnerSoundUrl = '{% url "game:serve_goal_sound" %}';
    const announcedWinners = new Set(); // Track which winners have been announced

    function showWinnerPopupAndPlaySound(winnerName) {
        // Skip if this winner was already announced
        if (announcedWinners.has(winnerName)) {
            console.log('Winner already announced:', winnerName);
            return;
        }
        
        // Mark as announced
        announcedWinners.add(winnerName);
        console.log('Showing winner popup for:', winnerName);

        document.getElementById('winnerName').textContent = winnerName;
        document.getElementById('winnerModal').style.display = 'flex';

        const audio = new Audio(winnerSoundUrl);
        audio.preload = 'auto';

        audio.addEventListener('canplaythrough', function() {
            audio.play().catch(e => console.error("Error playing goal sound:", e));
        }, { once: true });

        audio.load();
        
        // Auto-close popup after 5 seconds
        setTimeout(function() {
            closeModal();
        }, 5000);
    }

    function closeModal() {
        document.getElementById('winnerModal').style.display = 'none';
        
        // Note: We don't reset announcedWinners here because we want to track
        // all winners for the current game session. The set is cleared when
        // a new game starts (handled in backend by clearing session).
    }
    window.closeModal = closeModal;

    // ============================================
    // Master Transfer Functionality
    // ============================================
    function transferMasterTo(cyclistUserId) {
        if (!confirm('{% trans "M√∂chten Sie die Spielleiter-Rolle wirklich an" %} ' + cyclistUserId + ' {% trans "√ºbertragen?" %}')) {
            return;
        }
        
        // Get CSRF token from meta tag or form
        let csrfToken = '';
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            csrfToken = metaToken.getAttribute('content');
        } else {
            const inputToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (inputToken) {
                csrfToken = inputToken.value;
            }
        }
        
        fetch('{% url "game:transfer_master" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: 'cyclist_user_id=' + encodeURIComponent(cyclistUserId)
        })
        .then(response => {
            console.log('Transfer master response status:', response.status);
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'HTTP ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Transfer master response data:', data);
            if (data.status === 'master_transferred') {
                // CRITICAL: Force immediate sync by triggering multiple refresh events
                // This ensures both old and new master see the updated state immediately
                
                // 1. Refresh results table (updates master buttons visibility)
                htmx.trigger('#resultsTableBody', 'refresh');
                
                // 2. Refresh target_km_display if visible
                const targetKmDisplay = document.getElementById('targetKmDisplayContainer');
                if (targetKmDisplay) {
                    htmx.trigger('#targetKmDisplayContainer', 'refresh');
                }
                
                // 3. CRITICAL: Force a sync request to update session immediately
                // This ensures the new master's session is updated before page reload
                fetch('{% url "game:sync_session_endpoint" %}', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                }).then(response => response.json()).then(syncData => {
                    console.log('Session sync result:', syncData);
                    
                    // CRITICAL: Reload buttons via HTMX to get correct master status
                    // This ensures buttons are properly rendered with all HTMX attributes
                    const buttonsContainer = document.getElementById('gameButtonsContainer');
                    if (buttonsContainer) {
                        htmx.ajax('GET', '{% url "game:render_game_buttons" %}', {
                            target: '#gameButtonsContainer',
                            swap: 'innerHTML'
                        }).then(() => {
                            console.log('‚úÖ Buttons reloaded via HTMX');
                            
                            // Show success message
                            if (syncData.is_master) {
                                alert('{% trans "Spielleiter-Rolle wurde √ºbertragen. Die Buttons sind jetzt aktiv." %}');
                            } else {
                                alert('{% trans "Spielleiter-Rolle wurde √ºbertragen." %}');
                                // Reload after a short delay for old master
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500);
                            }
                        }).catch(err => {
                            console.error('Error reloading buttons:', err);
                            // Fallback: reload page
                            alert('{% trans "Spielleiter-Rolle wurde √ºbertragen." %}');
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        });
                    } else {
                        console.error('‚ùå gameButtonsContainer not found');
                        // Fallback: reload page
                        alert('{% trans "Spielleiter-Rolle wurde √ºbertragen." %}');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                }).catch(err => {
                    console.error('Error syncing after master transfer:', err);
                    // Still reload even if sync fails
                    alert('{% trans "Spielleiter-Rolle wurde √ºbertragen." %}');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                });
            } else if (data.error) {
                let errorMsg = data.error;
                if (data.debug) {
                    console.error('Debug info:', data.debug);
                }
                alert('Fehler: ' + errorMsg);
            }
        })
        .catch(error => {
            console.error('Error transferring master:', error);
            alert('{% trans "Fehler beim √úbertragen der Spielleiter-Rolle" %}: ' + error.message);
        });
    }
    // Function to activate master buttons (for new master after transfer)
    function activateMasterButtons() {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const endSessionButton = document.getElementById('endSessionButton');
        const explanationText = document.querySelector('.top-controls p');
        
        if (startButton && stopButton && endSessionButton) {
            // Remove disabled state and restore functionality
            startButton.disabled = false;
            startButton.style.opacity = '1';
            startButton.style.cursor = 'pointer';
            startButton.style.pointerEvents = 'auto';
            startButton.style.backgroundColor = '#28a745';
            startButton.setAttribute('hx-post', '{% url "game:start_game" %}');
            startButton.setAttribute('hx-target', '#startButton');
            startButton.setAttribute('hx-swap', 'none');
            startButton.setAttribute('hx-include', '[name="csrfmiddlewaretoken"]');
            startButton.setAttribute('hx-on::htmx:after-request', 'handleStartGameResponse(event)');
            
            stopButton.disabled = false;
            stopButton.style.opacity = '1';
            stopButton.style.cursor = 'pointer';
            stopButton.style.pointerEvents = 'auto';
            stopButton.style.backgroundColor = '#dc3545';
            stopButton.classList.remove('inactive');
            stopButton.setAttribute('hx-post', '{% url "game:start_game" %}');
            stopButton.setAttribute('hx-target', '#stopButton');
            stopButton.setAttribute('hx-swap', 'none');
            stopButton.setAttribute('hx-vals', '{"action": "stop"}');
            stopButton.setAttribute('hx-include', '[name="csrfmiddlewaretoken"]');
            stopButton.setAttribute('hx-on::htmx:after-request', 'handleStopGameResponse(event)');
            
            endSessionButton.disabled = false;
            endSessionButton.style.opacity = '1';
            endSessionButton.style.cursor = 'pointer';
            endSessionButton.style.pointerEvents = 'auto';
            endSessionButton.style.backgroundColor = '#f4a261';
            endSessionButton.setAttribute('hx-post', '{% url "game:end_session" %}');
            endSessionButton.setAttribute('hx-include', '[name="csrfmiddlewaretoken"]');
            endSessionButton.setAttribute('hx-confirm', '{% trans "Achtung! Dadurch wird der aktuelle Spielstand und alle Zuweisungen zur√ºckgesetzt. Sind Sie sicher?" %}');
            endSessionButton.setAttribute('hx-on::after-request', 'window.location.reload();');
            
            // Remove explanation text if present
            if (explanationText) {
                explanationText.remove();
            }
            
            // CRITICAL: Process HTMX attributes so they are recognized
            if (typeof htmx !== 'undefined') {
                // Process each button individually
                htmx.process(startButton);
                htmx.process(stopButton);
                htmx.process(endSessionButton);
                
                // Also process the parent container to ensure all attributes are recognized
                const topControls = document.querySelector('.top-controls');
                if (topControls) {
                    htmx.process(topControls);
                }
                
                console.log('‚úÖ HTMX attributes processed for all buttons');
            } else {
                console.error('‚ùå HTMX not available');
            }
            
            // Verify buttons are ready
            console.log('Button states:', {
                startButton: {
                    disabled: startButton.disabled,
                    hasHxPost: startButton.hasAttribute('hx-post'),
                    style: window.getComputedStyle(startButton).opacity
                },
                stopButton: {
                    disabled: stopButton.disabled,
                    hasHxPost: stopButton.hasAttribute('hx-post'),
                    style: window.getComputedStyle(stopButton).opacity
                },
                endSessionButton: {
                    disabled: endSessionButton.disabled,
                    hasHxPost: endSessionButton.hasAttribute('hx-post'),
                    style: window.getComputedStyle(endSessionButton).opacity
                }
            });
            
            console.log('‚úÖ Master buttons activated and HTMX processed');
        } else {
            console.error('‚ùå Could not find all buttons:', {startButton, stopButton, endSessionButton});
        }
    }
    
    // Function to deactivate master buttons (for old master after transfer)
    function deactivateMasterButtons() {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const endSessionButton = document.getElementById('endSessionButton');
        
        if (startButton && stopButton && endSessionButton) {
            startButton.disabled = true;
            startButton.style.opacity = '0.5';
            startButton.style.cursor = 'not-allowed';
            startButton.style.pointerEvents = 'none';
            startButton.removeAttribute('hx-post');
            
            stopButton.disabled = true;
            stopButton.style.opacity = '0.5';
            stopButton.style.cursor = 'not-allowed';
            stopButton.style.pointerEvents = 'none';
            stopButton.removeAttribute('hx-post');
            
            endSessionButton.disabled = true;
            endSessionButton.style.opacity = '0.5';
            endSessionButton.style.cursor = 'not-allowed';
            endSessionButton.style.pointerEvents = 'none';
            endSessionButton.removeAttribute('hx-post');
            
            console.log('‚úÖ Master buttons deactivated');
        }
    }
    
    // Make functions globally available
    window.transferMasterTo = transferMasterTo;
    window.activateMasterButtons = activateMasterButtons;
    window.deactivateMasterButtons = deactivateMasterButtons;
    
    // Also ensure it's available after HTMX updates
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'resultsTableBody') {
            // Re-ensure function is available
            if (typeof window.transferMasterTo === 'undefined') {
                window.transferMasterTo = transferMasterTo;
            }
        }
    });

    // ============================================
    // Target Kilometer Management
    // ============================================
    // Store the render_results_table URL for use in JavaScript
    const renderResultsTableUrl = '{% url "game:render_results_table" %}';
    
    // Track when user last interacted with target KM controls
    let lastUserInteractionTime = 0;
    const USER_INTERACTION_TIMEOUT = 2000; // 2 seconds
    
    // Function to update checkboxes and input field based on target_km value
    function updateTargetKmUI(targetKmValue) {
        const targetKmInput = document.getElementById('targetKm');
        if (!targetKmInput) {
            console.log('updateTargetKmUI: targetKmInput not found');
            return;
        }
        
        const value = parseFloat(targetKmValue) || 0;
        const currentValue = parseFloat(targetKmInput.value) || 0;
        
        console.log('updateTargetKmUI called:', { targetKmValue, value, currentValue, timeSinceLastInteraction: Date.now() - lastUserInteractionTime, justUnchecked });
        
        // Don't update if user interacted recently (within timeout period)
        const timeSinceLastInteraction = Date.now() - lastUserInteractionTime;
        if (timeSinceLastInteraction < USER_INTERACTION_TIMEOUT) {
            console.log('Skipping UI update - user interaction too recent (', timeSinceLastInteraction, 'ms ago)');
            return;
        }
        
        // Only update if value actually changed (with small epsilon for float comparison)
        if (Math.abs(value - currentValue) < 0.01) {
            console.log('Skipping UI update - value unchanged');
            return;
        }
        
        // Check if user is currently typing (input field has focus)
        if (document.activeElement === targetKmInput) {
            console.log('Skipping UI update - user is currently typing');
            return;
        }
        
        console.log('‚úÖ Updating target KM UI:', currentValue, '->', value);
        
        // Round value to integer (whole number only)
        const intValue = Math.round(value);
        
        // Update input field - preserve user's exact input if they're typing
        // Only update if the value is significantly different
        if (intValue > 0) {
            // Format value as integer (whole number only)
            targetKmInput.value = intValue.toString();
        } else {
            targetKmInput.value = '';
        }
        
        // Update checkboxes - only check if value exactly matches a checkbox value
        // BUT: Don't update checkboxes if user just unchecked (justUnchecked flag)
        // This prevents re-checking when user just unchecked a checkbox
        if (justUnchecked) {
            console.log('Skipping checkbox update - user just unchecked a checkbox (justUnchecked flag is true)');
            // Don't update checkboxes at all when justUnchecked is true
            // This prevents checkboxes from being re-checked after user unchecks them
            return; // Early return to prevent any checkbox updates
        }
        
        // Only update checkboxes if value > 0 (never check when value is 0)
        if (intValue > 0) {
            document.querySelectorAll('input[name="target_km_checkbox"]').forEach(cb => {
                const cbValue = parseInt(cb.value, 10);
                const shouldBeChecked = (intValue === cbValue);
                if (cb.checked !== shouldBeChecked) {
                    cb.checked = shouldBeChecked;
                    console.log('Updated checkbox', cb.id, 'to', shouldBeChecked);
                }
            });
        } else {
            // Value is 0 - uncheck all checkboxes
            console.log('Value is 0, unchecking all checkboxes');
            document.querySelectorAll('input[name="target_km_checkbox"]').forEach(cb => {
                if (cb.checked) {
                    cb.checked = false;
                    console.log('Unchecked checkbox', cb.id);
                }
            });
        }
    }
    
    // Initialize checkboxes and input field on page load
    document.addEventListener('DOMContentLoaded', function() {
        const targetKmInput = document.getElementById('targetKm');
        const currentValue = parseFloat(targetKmInput.value) || 0;
        updateTargetKmUI(currentValue);
    });
    
    // Track if user just unchecked a checkbox to prevent re-checking
    let justUnchecked = false;
    
    // Update checkboxes when table is updated via HTMX
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target && event.detail.target.id === 'resultsTableBody') {
            const tbody = event.detail.target;
            const targetKm = tbody.getAttribute('data-target-km');
            console.log('HTMX afterSwap - data-target-km:', targetKm, 'justUnchecked:', justUnchecked);
            
            if (targetKm !== null && targetKm !== '') {
                const targetKmValue = parseFloat(targetKm) || 0;
                // Always update UI - updateTargetKmUI will handle justUnchecked flag for checkboxes only
                // This ensures progress bars and kilometer synchronization continue to work
                updateTargetKmUI(targetKm);
            }
        }
    });
    
    function handleTargetKmCheckbox(kmValue) {
        // Record user interaction time
        lastUserInteractionTime = Date.now();
        
        const targetKmInput = document.getElementById('targetKm');
        const checkbox = document.getElementById('targetKm' + kmValue);
        const currentValue = parseFloat(targetKmInput.value) || 0;
        
        if (checkbox.checked) {
            // CRITICAL: Reset announced winners if target changed
            if (currentValue !== kmValue) {
                announcedWinners.clear();
                console.log('‚úÖ Target KM changed to', kmValue, '- announcedWinners cleared');
            }
            
            // Set input value
            targetKmInput.value = kmValue;
            // Uncheck all other checkboxes
            document.querySelectorAll('input[name="target_km_checkbox"]').forEach(cb => {
                if (cb.id !== checkbox.id) {
                    cb.checked = false;
                }
            });
            // Trigger HTMX update directly with the value
            console.log('Checkbox selected:', kmValue, 'Triggering HTMX update');
            // Use htmx.ajax to ensure the value is sent correctly
            htmx.ajax('GET', renderResultsTableUrl + '?target_km=' + kmValue, {
                target: '#resultsTableBody',
                swap: 'outerHTML',
                include: '#targetKm'
            });
        } else {
            // Clear input if checkbox is unchecked
            targetKmInput.value = '';
            // Uncheck all other checkboxes
            document.querySelectorAll('input[name="target_km_checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            // CRITICAL: Reset announced winners when target is cleared
            announcedWinners.clear();
            console.log('‚úÖ Target KM cleared - announcedWinners cleared');
            // Update lastTargetKm to prevent updateTargetKmUI from re-checking
            lastTargetKm = 0;
            // Set flag to prevent HTMX response from re-checking checkboxes
            justUnchecked = true;
            // Trigger HTMX update to clear target
            console.log('Checkbox unchecked, clearing target, justUnchecked set to true');
            htmx.ajax('GET', renderResultsTableUrl + '?target_km=', {
                target: '#resultsTableBody',
                swap: 'outerHTML',
                include: '#targetKm'
            });
            // Reset flag after HTMX response is processed (longer timeout to prevent re-checking)
            setTimeout(() => {
                justUnchecked = false;
                console.log('justUnchecked flag reset after checkbox uncheck');
            }, USER_INTERACTION_TIMEOUT * 2); // 4 seconds instead of 2
        }
    }

    // Store last target KM value to detect changes
    let lastTargetKm = 0;
    let inputDebounceTimer = null;
    
    // Prevent decimal input in target KM field - only allow digits
    function handleTargetKmKeydown(event) {
        // Allow: backspace (8), delete (46), tab (9), escape (27), enter (13)
        if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1) {
            return true;
        }
        
        // Allow: Ctrl+A (65), Ctrl+C (67), Ctrl+V (86), Ctrl+X (88)
        if ((event.keyCode === 65 || event.keyCode === 67 || event.keyCode === 86 || event.keyCode === 88) && event.ctrlKey === true) {
            return true;
        }
        
        // Allow: home (36), end (35), left (37), up (38), right (39), down (40)
        if (event.keyCode >= 35 && event.keyCode <= 40) {
            return true;
        }
        
        // Block: decimal point (190, 110), comma (188)
        if (event.keyCode === 190 || event.keyCode === 110 || event.keyCode === 188) {
            event.preventDefault();
            return false;
        }
        
        // Allow: digits 0-9 on main keyboard (48-57) and numpad (96-105)
        if ((event.keyCode >= 48 && event.keyCode <= 57) || (event.keyCode >= 96 && event.keyCode <= 105)) {
            return true;
        }
        
        // Block everything else (letters, special characters, etc.)
        event.preventDefault();
        return false;
    }
    
    // Handle paste events to remove decimal points and commas
    function handleTargetKmPaste(event) {
        event.preventDefault();
        const paste = (event.clipboardData || window.clipboardData).getData('text');
        // Remove all non-digit characters (keep only 0-9)
        const digitsOnly = paste.replace(/[^0-9]/g, '');
        const targetKmInput = document.getElementById('targetKm');
        if (targetKmInput) {
            targetKmInput.value = digitsOnly;
            // Trigger input handler to process the value
            handleTargetKmInput();
        }
    }
    
    function handleTargetKmInput() {
        // Record user interaction time
        lastUserInteractionTime = Date.now();
        
        const targetKmInput = document.getElementById('targetKm');
        let inputValueStr = targetKmInput.value.trim();
        
        // Remove any decimal points or commas that might have been pasted
        inputValueStr = inputValueStr.replace(/[.,]/g, '');
        
        // Parse as integer (whole number only)
        const inputValue = parseInt(inputValueStr, 10) || 0;
        
        // Update the input field to show only whole number
        if (inputValueStr !== '' && inputValue > 0) {
            targetKmInput.value = inputValue;
        } else if (inputValueStr === '') {
            targetKmInput.value = '';
        }
        
        // Uncheck all checkboxes if value doesn't match any checkbox
        // Only check if value exactly matches a checkbox value
        document.querySelectorAll('input[name="target_km_checkbox"]').forEach(cb => {
            const cbValue = parseInt(cb.value, 10);
            cb.checked = (inputValue > 0 && inputValue === cbValue);
        });
        
        // Debounce: Wait 500ms after user stops typing before sending to server
        if (inputDebounceTimer) {
            clearTimeout(inputDebounceTimer);
        }
        
        inputDebounceTimer = setTimeout(() => {
            // Only send if value actually changed
            if (Math.abs(inputValue - lastTargetKm) > 0.01) {
                // CRITICAL: Reset announced winners if target changed
                announcedWinners.clear();
                console.log('‚úÖ Target KM changed from', lastTargetKm, 'to', inputValue, '- announcedWinners cleared');
                lastTargetKm = inputValue;
                
                // Send value to server via HTMX (as integer)
                if (inputValue > 0) {
                    console.log('Sending target KM to server:', inputValue);
                    htmx.ajax('GET', renderResultsTableUrl + '?target_km=' + encodeURIComponent(inputValue), {
                        target: '#resultsTableBody',
                        swap: 'outerHTML',
                        include: '#targetKm'
                    });
                } else {
                    // Clear target if input is empty or 0
                    console.log('Clearing target KM');
                    htmx.ajax('GET', renderResultsTableUrl + '?target_km=', {
                        target: '#resultsTableBody',
                        swap: 'outerHTML',
                        include: '#targetKm'
                    });
                }
            }
        }, 500); // 500ms debounce
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Schieberegler-Logik entfernt
        
        // Update checkboxes after initial table load
        setTimeout(() => {
            const tbody = document.getElementById('resultsTableBody');
            if (tbody) {
                const targetKm = tbody.getAttribute('data-target-km');
                if (targetKm) {
                    updateTargetKmUI(targetKm);
                }
            }
        }, 100);
        
        // Debug: Check if HTMX is loaded
        console.log('DOMContentLoaded - HTMX available:', typeof htmx !== 'undefined');
        if (typeof htmx === 'undefined') {
            console.error('HTMX is not loaded!');
            alert('HTMX konnte nicht geladen werden. Bitte Seite neu laden.');
        }
        
        // Initialize GameStateManager on page load
        GameStateManager.init();
    });

    // ============================================
    // GameStateManager - Centralized State Management
    // ============================================
    const GameStateManager = {
        _isRunning: false,
        
        init() {
            // Initialize from table data if available
            const tbody = document.getElementById('resultsTableBody');
            if (tbody && tbody.dataset.gameActive) {
                const isActive = tbody.dataset.gameActive === 'true';
                const isStopped = tbody.dataset.gameStopped === 'true';
                this._isRunning = isActive && !isStopped;
            }
            this.updateButtons();
        },
        
        isRunning() {
            return this._isRunning;
        },
        
        setGameRunning(running) {
            console.log('GameStateManager.setGameRunning(' + running + ')');
            this._isRunning = running;
            this.updateButtons();
        },
        
        updateButtons() {
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (!startButton || !stopButton) {
                console.warn('Buttons not found in updateButtons()');
                return;
            }
            
            console.log('Updating buttons: isRunning=' + this._isRunning);
            
            // Use requestAnimationFrame to ensure immediate visual update
            requestAnimationFrame(() => {
                if (this._isRunning) {
                    // Game is running: Start disabled, Stop enabled
                    startButton.classList.add('inactive');
                    stopButton.classList.remove('inactive');
                    // Force immediate style update
                    startButton.style.opacity = '0.4';
                    startButton.style.backgroundColor = '#6c757d';
                    startButton.style.pointerEvents = 'none';
                    stopButton.style.opacity = '1';
                    stopButton.style.backgroundColor = '#dc3545';
                    stopButton.style.pointerEvents = 'auto';
                    console.log('Game running: Start=inactive, Stop=active');
                } else {
                    // Game is stopped: Start enabled, Stop disabled
                    startButton.classList.remove('inactive');
                    stopButton.classList.add('inactive');
                    // Force immediate style update
                    startButton.style.opacity = '1';
                    startButton.style.backgroundColor = '#28a745';
                    startButton.style.pointerEvents = 'auto';
                    stopButton.style.opacity = '0.4';
                    stopButton.style.backgroundColor = '#6c757d';
                    stopButton.style.pointerEvents = 'none';
                    console.log('Game stopped: Start=active, Stop=inactive');
                }
            });
        },
        
        syncFromTable() {
            const tbody = document.getElementById('resultsTableBody');
            if (tbody && tbody.dataset.gameActive) {
                const isActive = tbody.dataset.gameActive === 'true';
                const isStopped = tbody.dataset.gameStopped === 'true';
                const newRunningState = isActive && !isStopped;
                if (newRunningState !== this._isRunning) {
                    console.log('State changed from table: isRunning=' + newRunningState);
                    this._isRunning = newRunningState;
                    this.updateButtons();
                }
            }
        }
    };

    // ============================================
    // Button Event Handlers - Direct and Immediate
    // ============================================
    function handleStartGameResponse(event) {
        console.log('handleStartGameResponse called', event.detail);
        if (event.detail && event.detail.successful) {
            // CRITICAL: Reset announced winners when starting a new game
            // This ensures that winners can be announced again in the new game
            announcedWinners.clear();
            console.log('‚úÖ New game started: announcedWinners cleared');
            
            // Update buttons IMMEDIATELY with direct DOM manipulation
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (startButton && stopButton) {
                // Direct style update for immediate visual feedback
                startButton.style.opacity = '0.4';
                startButton.style.backgroundColor = '#6c757d';
                startButton.style.pointerEvents = 'none';
                startButton.classList.add('inactive');
                
                stopButton.style.opacity = '1';
                stopButton.style.backgroundColor = '#dc3545';
                stopButton.style.pointerEvents = 'auto';
                stopButton.classList.remove('inactive');
            }
            
            // Update state manager
            GameStateManager.setGameRunning(true);
            
            // Reload table after a short delay
            setTimeout(() => {
                htmx.trigger('#resultsTableBody', 'refresh');
            }, 50);
        } else {
            alert('{% trans "Spiel konnte nicht gestartet werden (evtl. keine Zuweisungen aktiv)." %}');
        }
    }

    function handleStopGameResponse(event) {
        console.log('handleStopGameResponse called', event.detail);
        if (event.detail && event.detail.successful) {
            // Update buttons IMMEDIATELY with direct DOM manipulation
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (startButton && stopButton) {
                // Direct style update for immediate visual feedback
                startButton.style.opacity = '1';
                startButton.style.backgroundColor = '#28a745';
                startButton.style.pointerEvents = 'auto';
                startButton.classList.remove('inactive');
                
                stopButton.style.opacity = '0.4';
                stopButton.style.backgroundColor = '#6c757d';
                stopButton.style.pointerEvents = 'none';
                stopButton.classList.add('inactive');
            }
            
            // Update state manager
            GameStateManager.setGameRunning(false);
            
            // Reload table after a short delay
            setTimeout(() => {
                htmx.trigger('#resultsTableBody', 'refresh');
            }, 50);
        } else {
            alert('{% trans "Spiel konnte nicht gestoppt werden." %}');
        }
    }

    // Global HTMX event listeners for button state management (backup)
    document.body.addEventListener('htmx:afterRequest', function(event) {
        const target = event.detail.target || event.target;
        const successful = event.detail.successful;
        
        // Handle Start button response
        if (target && target.id === 'startButton' && successful) {
            console.log('Global handler: Start button successful');
            // CRITICAL: Reset announced winners when starting a new game
            announcedWinners.clear();
            console.log('‚úÖ Global handler: announcedWinners cleared');
            
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (startButton && stopButton) {
                startButton.style.opacity = '0.4';
                startButton.style.backgroundColor = '#6c757d';
                startButton.style.pointerEvents = 'none';
                startButton.classList.add('inactive');
                
                stopButton.style.opacity = '1';
                stopButton.style.backgroundColor = '#dc3545';
                stopButton.style.pointerEvents = 'auto';
                stopButton.classList.remove('inactive');
            }
            
            GameStateManager.setGameRunning(true);
            setTimeout(() => {
                htmx.trigger('#resultsTableBody', 'refresh');
            }, 50);
        }
        
        // Handle Stop button response
        if (target && target.id === 'stopButton' && successful) {
            console.log('Global handler: Stop button successful');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (startButton && stopButton) {
                startButton.style.opacity = '1';
                startButton.style.backgroundColor = '#28a745';
                startButton.style.pointerEvents = 'auto';
                startButton.classList.remove('inactive');
                
                stopButton.style.opacity = '0.4';
                stopButton.style.backgroundColor = '#6c757d';
                stopButton.style.pointerEvents = 'none';
                stopButton.classList.add('inactive');
            }
            
            GameStateManager.setGameRunning(false);
            setTimeout(() => {
                htmx.trigger('#resultsTableBody', 'refresh');
            }, 50);
        }
    });

    // Sync state from table after HTMX swaps
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'resultsTableBody') {
            GameStateManager.syncFromTable();
            
            // Update master badge based on data-is-master attribute
            const tbody = event.target;
            const isMaster = tbody.getAttribute('data-is-master') === 'true';
            const roomCode = tbody.getAttribute('data-room-code');
            const masterBadge = document.getElementById('masterBadge');
            const masterActions = document.getElementById('masterActions');
            const roomInfo = document.getElementById('roomInfo');
            
            // Check if room was ended (room_code was cleared)
            if (!roomCode && roomInfo) {
                // Room was ended - redirect to game page
                console.log('üèÅ Raum wurde beendet, leite um...');
                setTimeout(() => {
                    window.location.href = '{% url "game:game_page" %}';
                }, 1000);
                return;
            }
            
            // CRITICAL: Check if master status changed
            const previousIsMaster = masterBadge ? (masterBadge.style.display !== 'none') : false;
            const masterStatusChanged = (previousIsMaster !== isMaster);
            
            if (masterStatusChanged) {
                console.log('üëë Master-Status ge√§ndert:', previousIsMaster, '->', isMaster);
            }
            
            if (masterBadge) {
                masterBadge.style.display = isMaster ? 'inline-block' : 'none';
            }
            if (masterActions) {
                masterActions.style.display = isMaster ? 'inline-block' : 'none';
            }
            // Also update master tip visibility
            const masterTip = document.getElementById('masterTip');
            if (masterTip) {
                masterTip.style.display = isMaster ? 'block' : 'none';
            }
            
            // CRITICAL: If master status changed and we're now the master, trigger immediate refresh
            // This ensures the new master sees the badge immediately
            if (masterStatusChanged && isMaster && roomCode) {
                console.log('üëë Neuer Master erkannt, aktualisiere UI sofort...');
                // Trigger immediate refresh of target_km_display if visible
                const targetKmDisplay = document.getElementById('targetKmDisplayContainer');
                if (targetKmDisplay) {
                    htmx.trigger('#targetKmDisplayContainer', 'refresh');
                }
            }
            
            // Ensure transferMasterTo buttons work after HTMX update
            // Use event delegation to handle clicks on dynamically added buttons
            const transferButtons = tbody.querySelectorAll('button[onclick*="transferMasterTo"]');
            transferButtons.forEach(button => {
                // Remove old onclick and add new event listener
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes('transferMasterTo')) {
                    const match = onclickAttr.match(/transferMasterTo\('([^']+)'\)/);
                    if (match) {
                        const cyclistName = match[1];
                        button.removeAttribute('onclick');
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (typeof window.transferMasterTo === 'function') {
                                window.transferMasterTo(cyclistName);
                            } else {
                                console.error('transferMasterTo function not available');
                                alert('{% trans "Fehler: Funktion nicht verf√ºgbar. Bitte Seite neu laden." %}');
                            }
                        });
                    }
                }
            });
            
            // Winner check and sound trigger - handle multiple new winners
            const newWinnersStr = tbody.dataset.newWinners || '';
            if (newWinnersStr) {
                const newWinners = newWinnersStr.split(',').filter(w => w.trim() !== '');
                console.log('New winners detected:', newWinners, 'announcedWinners size:', announcedWinners.size);
                // Show popup for each new winner (one at a time)
                newWinners.forEach((winnerName, index) => {
                    setTimeout(() => {
                        showWinnerPopupAndPlaySound(winnerName);
                    }, index * 2000); // 2 seconds between each popup
                });
            } else {
                console.log('No new winners in this update');
            }
        }
    });
    
    // Also sync on load event
    document.addEventListener('htmx:load', function(event) {
        if (event.target.id === 'resultsTableBody') {
            GameStateManager.syncFromTable();
        }
    });
    
    // Information Hub Modal functions
    function openInfoHubModal() {
        var overlay = document.getElementById('info-hub-modal-overlay');
        if (overlay) {
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }
    
    function closeInfoHubModal(event) {
        if (event && event.target !== event.currentTarget) {
            return; // Don't close if clicking inside modal
        }
        var overlay = document.getElementById('info-hub-modal-overlay');
        if (overlay) {
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
    }
    
    function toggleInfoHubFAQItem(header) {
        var item = header.closest('.info-hub-accordion-item');
        if (item) {
            item.classList.toggle('open');
        }
    }

    // Share Room Function
    function shareRoom(roomUrl, roomCode) {
        const shareTitle = 'MyCyclingCity: {% trans "Spiel-Raum beitreten" %}';
        const shareText = '{% trans "Tritt meinem Spiel-Raum bei!" %}: ' + roomCode;
        
        // Try Web Share API first (mobile devices)
        if (navigator.share) {
            navigator.share({
                title: shareTitle,  // Used as subject in email, title in other apps
                text: shareText,
                url: roomUrl
            }).then(() => {
                console.log('‚úÖ Raum erfolgreich geteilt');
            }).catch((error) => {
                console.log('Fehler beim Teilen:', error);
                // Fallback: Try mailto link for email sharing
                if (error.name !== 'AbortError') {
                    copyToClipboard(roomUrl, roomCode);
                }
            });
        } else {
            // Fallback: Check if user wants to share via email
            // For email, we can use mailto with subject prefix
            copyToClipboard(roomUrl, roomCode);
        }
    }
    
    function copyToClipboard(roomUrl, roomCode) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(roomUrl).then(() => {
                showShareMessage('{% trans "Raum-URL wurde in die Zwischenablage kopiert!" %}');
            }).catch((err) => {
                console.error('Fehler beim Kopieren:', err);
                fallbackCopyToClipboard(roomUrl, roomCode);
            });
        } else {
            fallbackCopyToClipboard(roomUrl, roomCode);
        }
    }
    
    function fallbackCopyToClipboard(roomUrl, roomCode) {
        const textArea = document.createElement('textarea');
        textArea.value = roomUrl;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showShareMessage('{% trans "Raum-URL wurde in die Zwischenablage kopiert!" %}');
            } else {
                showShareMessage('{% trans "Bitte kopieren Sie die URL manuell:" %} ' + roomUrl, true);
            }
        } catch (err) {
            console.error('Fehler beim Kopieren:', err);
            showShareMessage('{% trans "Bitte kopieren Sie die URL manuell:" %} ' + roomUrl, true);
        }
        
        document.body.removeChild(textArea);
    }
    
    function shareViaEmail(roomUrl, roomCode) {
        const subject = encodeURIComponent('MyCyclingCity: {% trans "Spiel-Raum beitreten" %} - ' + roomCode);
        const body = encodeURIComponent('{% trans "Tritt meinem Spiel-Raum bei!" %}\n\n' + 
                                       '{% trans "Raum-Code" %}: ' + roomCode + '\n' +
                                       '{% trans "Link" %}: ' + roomUrl);
        const mailtoLink = 'mailto:?subject=' + subject + '&body=' + body;
        window.location.href = mailtoLink;
    }
    
    function showShareMessage(message, showUrl = false) {
        let messageDiv = document.getElementById('shareMessage');
        if (!messageDiv) {
            messageDiv = document.createElement('div');
            messageDiv.id = 'shareMessage';
            messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background-color: #28a745; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10000; font-weight: bold; max-width: 300px;';
            document.body.appendChild(messageDiv);
        }
        
        messageDiv.innerHTML = message;
        if (showUrl) {
            const urlDiv = document.createElement('div');
            urlDiv.style.cssText = 'margin-top: 8px; font-size: 0.85em; word-break: break-all; background-color: rgba(255,255,255,0.2); padding: 4px; border-radius: 2px;';
            urlDiv.textContent = message.split(': ')[1] || '';
            messageDiv.appendChild(urlDiv);
        }
        
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                messageDiv.style.display = 'none';
                messageDiv.style.opacity = '1';
            }, 300);
        }, 3000);
    }
</script>
